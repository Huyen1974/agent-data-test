rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Knowledge documents - legacy collection (deprecated)
    match /knowledge_documents/{document=**} {
      allow read: if request.auth != null;
      allow write: if request.auth != null &&
                      (request.auth.token.role == 'owner' ||
                       request.auth.token.role == 'editor');
    }

    // Test environment knowledge documents (Constitution QD-LAW ยง2 compliant)
    match /test_documents/{document=**} {
      allow read: if request.auth != null;
      allow write: if request.auth != null &&
                      (request.auth.token.role == 'owner' ||
                       request.auth.token.role == 'editor');
    }

    // Production environment knowledge documents (Constitution QD-LAW ยง2 compliant)
    match /production_documents/{document=**} {
      allow read: if request.auth != null;
      allow write: if request.auth != null &&
                      (request.auth.token.role == 'owner' ||
                       request.auth.token.role == 'editor');
    }

    // Process templates - allow authenticated users to read
    match /process_templates/{document=**} {
      allow read: if request.auth != null;
      allow write: if request.auth != null &&
                      (request.auth.token.role == 'owner' ||
                       request.auth.token.role == 'editor');
    }

    // Process runs - allow authenticated users to read their own runs
    match /process_runs/{document=**} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }

    // ID mapping registry - restrict to system access only
    match /id_mapping_registry/{document=**} {
      allow read: if request.auth != null && request.auth.token.role == 'owner';
      allow write: if request.auth != null && request.auth.token.role == 'owner';
    }

    // Default deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
