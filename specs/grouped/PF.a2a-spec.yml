spec_text: |
  # File 1: pf_envelope.yml (Phần II.1-2 – 37 ID, Cover Foundation Envelope/Schema)
  - id: PF-ENV-001
    title: Tiêu chuẩn Áp dụng - Nền tảng OpenAI Function Calling hybrid MCP structured output (Jun 18 2025) hỗ trợ tool results/resource links
    spec_ref: Phần II §1
    doc_cite: MD:L23-L25
    acceptance:
      tests: ["tests/pf/test_envelope_standard.py::test_openai_mcp_hybrid"]
      code_markers: ["@req:PF-ENV-001"]
      runtime_assertions: []
  - id: PF-ENV-002
    title: payload.schema_version MUST map tới JSON Schema in repo schemas/; CI BLOCK nếu payload không validate
    spec_ref: Phần II §1 (Bổ sung Schema & SDK)
    doc_cite: MD:L27-L28
    acceptance:
      tests: ["tests/pf/test_schema_map.py::test_payload_schema_map_ci_block"]
      code_markers: ["@req:PF-ENV-002"]
      runtime_assertions: ["CI BLOCK if not validate"]
  - id: PF-ENV-003
    title: SDK TS/Python MUST be generated từ OpenAPI/JSON-Schema; không merge nếu SDK không đồng bộ
    spec_ref: Phần II §1 (Bổ sung Schema & SDK)
    doc_cite: MD:L27-L28
    acceptance:
      tests: ["tests/pf/test_sdk_generation.py::test_sdk_generated_no_merge_outsync"]
      code_markers: ["@req:PF-ENV-003"]
      runtime_assertions: ["no merge if SDK not đồng bộ"]
  - id: PF-ENV-004
    title: Envelope v2.2 - BẮT BUỘC đủ trường (version to payload), bổ sung resource_links/context_id; NOTE: Encryption sensitive payload trỏ SG-ENC-001 (JWE/AES-GCM, cấm cleartext)
    spec_ref: Phần II §2
    doc_cite: MD:L30-L75
    acceptance:
      tests: ["tests/pf/test_envelope_v2.py::test_required_fields"]
      code_markers: ["@req:PF-ENV-004"]
      runtime_assertions: ["trỏ SG-ENC-001 for encryption"]
  - id: PF-ENV-005
    title: version: "1.0"
    spec_ref: Phần II §2
    doc_cite: MD:L35
    acceptance:
      tests: ["tests/pf/test_envelope_fields.py::test_version"]
      code_markers: ["@req:PF-ENV-005"]
      runtime_assertions: []
  - id: PF-ENV-006
    title: request_id: <uuid>
    spec_ref: Phần II §2
    doc_cite: MD:L37
    acceptance:
      tests: ["tests/pf/test_envelope_fields.py::test_request_id_uuid"]
      code_markers: ["@req:PF-ENV-006"]
      runtime_assertions: []
  - id: PF-ENV-007
    title: correlation_id: <uuid>
    spec_ref: Phần II §2
    doc_cite: MD:L39
    acceptance:
      tests: ["tests/pf/test_envelope_fields.py::test_correlation_id_uuid"]
      code_markers: ["@req:PF-ENV-007"]
      runtime_assertions: []
  - id: PF-ENV-008
    title: causation_id: <uuid> // ID của tin nhắn gây ra hành động này; invariant causation_id == request_id của message trước
    spec_ref: Phần II §2
    doc_cite: MD:L41
    acceptance:
      tests: ["tests/pf/test_envelope_fields.py::test_causation_id"]
      code_markers: ["@req:PF-ENV-008"]
      runtime_assertions: []
  - id: PF-CAUS-001
    title: Causation chain invariant - causation_id MUST == request_id của message gây ra hành động trước
    spec_ref: Phần II §2 (Ghi chú Vận hành)
    doc_cite: MD:L39-L45
    acceptance:
      tests: ["tests/pf/test_causation.py::test_chain_invariant_request_id"]
      code_markers: ["@req:PF-CAUS-001"]
      runtime_assertions: ["causation_id == prev request_id"]
  - id: PF-CORR-001
    title: correlation_id scope theo saga/job - Tất cả events thuộc cùng job MUST giữ nguyên correlation_id
    spec_ref: Phần II §2 (Ghi chú Vận hành)
    doc_cite: MD:L39
    acceptance:
      tests: ["tests/pf/test_correlation.py::test_job_scope_same_id"]
      code_markers: ["@req:PF-CORR-001"]
      runtime_assertions: ["same correlation_id per job"]
  - id: PF-ENV-009
    title: trace_id: <w3c-trace-id>
    spec_ref: Phần II §2
    doc_cite: MD:L45-L46
    acceptance:
      tests: ["tests/pf/test_envelope_fields.py::test_trace_id_w3c"]
      code_markers: ["@req:PF-ENV-009"]
      runtime_assertions: []
  - id: PF-ENV-010
    title: tenant_id: <string>
    spec_ref: Phần II §2
    doc_cite: MD:L47
    acceptance:
      tests: ["tests/pf/test_envelope_fields.py::test_tenant_id"]
      code_markers: ["@req:PF-ENV-010"]
      runtime_assertions: []
  - id: PF-LOC-001
    title: data_locality ràng buộc - SHOULD khớp ^[a-z]+(-[a-z0-9]+)+[0-9]$ (vd. asia-southeast1); linter cảnh báo nếu lệch
    spec_ref: Phần II §2
    doc_cite: MD:L49
    acceptance:
      tests: ["tests/pf/test_locality.py::test_region_pattern_warn"]
      code_markers: ["@req:PF-LOC-001"]
      runtime_assertions: ["warn if mismatch"]
  - id: PF-ENV-011
    title: data_locality: <string> // Ví dụ: "asia-southeast1"
    spec_ref: Phần II §2
    doc_cite: MD:L49
    acceptance:
      tests: ["tests/pf/test_envelope_fields.py::test_data_locality"]
      code_markers: ["@req:PF-ENV-011"]
      runtime_assertions: []
  - id: PF-ENV-012
    title: principal: {"sub": "service-account-id
