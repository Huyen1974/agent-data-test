spec_text: |
  # File 2: ro_state_machine.yml (Phần II.3-14 – 41 ID, Cover Resilient Operations State/Error/Transport)
  - id: RO-STM-001
    title: Máy trạng thái & Quy tắc Phản hồi - Tinh chỉnh bổ sung trạng thái và quy tắc hủy tác vụ đầy đủ
    spec_ref: Phần II §3
    doc_cite: MD:L75
    acceptance:
      tests: ["tests/ro/test_state_machine.py::test_overall_refinement"]
      code_markers: ["@req:RO-STM-001"]
      runtime_assertions: []
  - id: RO-STM-002
    title: Máy trạng thái - Một tác vụ sẽ đi qua các trạng thái: ACKED → RUNNING → (SUCCEEDED | FAILED) → (COMPENSATED? | CANCELLED?)
    spec_ref: Phần II §4
    doc_cite: MD:L77
    acceptance:
      tests: ["tests/ro/test_state_machine.py::test_transitions"]
      code_markers: ["@req:RO-STM-002"]
      runtime_assertions: []
  - id: RO-RESP-001
    title: Phản hồi - Đồng bộ (<2s): Trả về SUCCEEDED hoặc FAILED
    spec_ref: Phần II §5
    doc_cite: MD:L89-L91
    acceptance:
      tests: ["tests/ro/test_response.py::test_sync_under_2s"]
      code_markers: ["@req:RO-RESP-001"]
      runtime_assertions: []
  - id: RO-RESP-002
    title: Phản hồi - Bất đồng bộ: Trả về ACKED, sau đó phát các sự kiện *.running, *.done
    spec_ref: Phần II §6
    doc_cite: MD:L89-L91
    acceptance:
      tests: ["tests/ro/test_response.py::test_async_ack_events"]
      code_markers: ["@req:RO-RESP-002"]
      runtime_assertions: []
  - id: RO-RESP-003
    title: Async-first enforcement - Nếu dự kiến >2s, MUST dùng async (ACK + events); linter FAIL nếu action registry không khai ETA hợp lý
    spec_ref: Phần II §6 (Bổ sung enforcement từ Phần I.4)
    doc_cite: MD:L13-L14 + L89-L91
    acceptance:
      tests: ["tests/ro/test_async_first.py::test_enforce_over_2s_linter"]
      code_markers: ["@req:RO-RESP-003"]
      runtime_assertions: []
  - id: RO-RESP-004
    title: HTTP 202 cho ACK async - SHOULD dùng 202 Accepted nếu profile HTTP-sync
    spec_ref: Phần II §6
    doc_cite: MD:L89-L91
    acceptance:
      tests: ["tests/ro/test_response.py::test_ack_http_202_recommended"]
      code_markers: ["@req:RO-RESP-004"]
      runtime_assertions: []
  - id: RO-CANCEL-001
    title: Hủy tác vụ - Một Agent có thể gửi *.cancel. Nếu RUNNING, chuyển CANCELLED và kích hoạt compensation nếu cần (side-effects observed → .compensated; else .cancelled)
    spec_ref: Phần II §7
    doc_cite: MD:L93-L95
    acceptance:
      tests: ["tests/ro/test_cancel.py::test_cancel_running_compensate_trigger"]
      code_markers: ["@req:RO-CANCEL-001"]
      runtime_assertions: []
  - id: RO-CANCEL-002
    title: Cancel idempotency - Gửi .cancel nhiều lần chỉ phát 1 lần hiệu lực; lần sau no-op (dedupe theo idempotency_key + subject)
    spec_ref: Phần II §7
    doc_cite: MD:L93-L95
    acceptance:
      tests: ["tests/ro/test_cancel.py::test_idempotency_multiple_noop"]
      code_markers: ["@req:RO-CANCEL-002"]
      runtime_assertions: ["dedupe cancel"]
  - id: RO-CANCEL-003
    title: Cancel sau khi DONE - SHOULD no-op idempotent (không phát event thêm, không đảo trạng thái; SHOULD 200 cho idempotent; no .compensated nếu FAILED)
    spec_ref: Phần II §7
    doc_cite: MD:L93-L95
    acceptance:
      tests: ["tests/ro/test_cancel.py::test_after_done_noop_200_failed"]
      code_markers: ["@req:RO-CANCEL-003"]
      runtime_assertions: []
  - id: RO-SEM-001
    title: Semantics at-least-once, đích MUST dedupe theo idempotency_key và bỏ qua out-of-order nếu seq < last_seq_seen; SHOULD order events theo seq tăng per-subject; SHOULD recovery replay .done nếu dedupe processed message
    spec_ref: Phần II §7
    doc_cite: MD:L93-L95
    acceptance:
      tests: ["tests/ro/test_semantics.py::test_at_least_once_dedupe_out_of_order_shold_seq_recovery"]
      code_markers: ["@req:RO-SEM-001"]
      runtime_assertions: []
  - id: RO-SEQ-001
    title: Seq reset on MAJOR - Nếu action_version tăng MAJOR, seq có thể reset (không coi out-of-order); else đơn điệu tăng per-subject
    spec_ref: Phần II §7
    doc_cite: MD:L79-L83
    acceptance:
      tests: ["tests/ro/test_seq.py::test_accept_reset_on_major_bump"]
      code_markers: ["@req:RO-SEQ-001"]
      runtime_assertions: []
  - id: RO-NAME-001
    title: Mapping state-event - ACKED → .accepted, RUNNING → .running, SUCCEEDED/FAILED → .done (status=SUCCEEDED|FAILED), CANCELLED → .cancelled, COMPENSATED → .compensated
    spec_ref: Phần II §7 (Bổ sung mapping từ Phần VI Naming)
    doc_cite: MD:L85-L91 + L264
    acceptance:
      tests: ["tests/ro/test_state_event_mapping.py::test_acked_accepted_done_status"]
      code_markers: ["@req:RO-NAME-001"]
      runtime_assertions: []
  - id: RO-EVENT-001
    title: Event payload cho .done - MUST có status ∈ {SUCCEEDED, FAILED}; nếu FAILED thì MUST có error.code
