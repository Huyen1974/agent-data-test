spec_text: |
  # File 3: sg_security.yml (Phần IV – 33 ID, Cover Security & Governance)
  - id: SG-SEC-001
    title: Xác thực Agent-to-Agent (A2A) - principal trong Message Envelope phải được xác thực qua Google Cloud IAM hoặc JWT
    spec_ref: Phần IV §1
    doc_cite: MD:L121
    acceptance:
      tests: ["tests/sg/test_auth.py::test_principal_iam_jwt"]
      code_markers: ["@req:SG-SEC-001"]
      runtime_assertions: []
  - id: SG-SEC-002
    title: Các client bên ngoài phải tuân thủ OAuth 2.0 Resource Indicators (RFC 8707) (MCP Jun 18 2025 chống malicious)
    spec_ref: Phần IV §1
    doc_cite: MD:L135-L136
    acceptance:
      tests: ["tests/sg/test_auth.py::test_oauth_rfc8707"]
      code_markers: ["@req:SG-SEC-002"]
      runtime_assertions: []
  - id: SG-INT-001
    title: Thông điệp từ external agents MUST kèm JWS; verify trước enqueue; reject nếu thuật toán không allowlist
    spec_ref: Phần IV §1 (Bổ sung Integrity)
    doc_cite: MD:L139-L141
    acceptance:
      tests: ["tests/sg/test_integrity.py::test_jws_verify_enqueue_allowlist"]
      code_markers: ["@req:SG-INT-001"]
      runtime_assertions: []
  - id: SG-JWS-001
    title: JWS thuật toán Ed25519/EdDSA (allowlist), header kid (key ID), SHOULD rotate 90 ngày
    spec_ref: Phần IV §1 (Bổ sung Integrity)
    doc_cite: MD:L139-L141
    acceptance:
      tests: ["tests/sg/test_jws.py::test_ed25519_kid_rotate_config_shold"]
      code_markers: ["@req:SG-JWS-001"]
      runtime_assertions: ["reject if not allowed"]
  - id: SG-PROF-001
    title: Security profiles: A2A-Basic (nội bộ) & A2A-External (yêu cầu JWS, throttle chặt hơn)
    spec_ref: Phần IV §1 (Bổ sung Profiles)
    doc_cite: MD:L143
    acceptance:
      tests: ["tests/sg/test_profiles.py::test_basic_external_throttle"]
      code_markers: ["@req:SG-PROF-001"]
      runtime_assertions: []
  - id: SG-PROF-002
    title: A2A-External throttle chặt hơn Basic (config-check test: external_qps < internal_qps)
    spec_ref: Phần IV §1
    doc_cite: MD:L143
    acceptance:
      tests: ["tests/sg/test_profiles.py::test_external_throttle_config_is_tighter"]
      code_markers: ["@req:SG-PROF-002"]
      runtime_assertions: []
  - id: SG-RATE-001
    title: Giới hạn Tần suất (Rate Limiting) - Ngoài X-RateLimit-*, enforce quota principal/tenant_id; đồng bộ trả X-RateLimit-Limit/Remaining/Retry-After (tính theo policy, không phải eta_sec); SHOULD numeric seconds cho 429; bất đồng bộ event lỗi nếu vượt
    spec_ref: Phần IV §2
    doc_cite: MD:L145
    acceptance:
      tests: ["tests/sg/test_rate_limit.py::test_quota_headers_event_policy_numeric"]
      code_markers: ["@req:SG-RATE-001"]
      runtime_assertions: ["RATE_LIMIT_EXCEEDED on exceed"]
  - id: SG-DLQ-001
    title: Hàng đợi & DLQ - Bắt buộc DLQ, retry 6 lần exponential backoff + jitter; DLQ redrive thủ công với audit (dùng tool TD-APP-02; MUST log actor/lý do/số lượng)
    spec_ref: Phần IV §3
    doc_cite: MD:L147
    acceptance:
      tests: ["tests/sg/test_dlq.py::test_retry6_redrive_audit_record"]
      code_markers: ["@req:SG-DLQ-001"]
      runtime_assertions: []
  - id: SG-OBS-001
    title: Giám sát & Truy vết - trace_id phải được truyền suốt
    spec_ref: Phần IV §4
    doc_cite: MD:L151
    acceptance:
      tests: ["tests/sg/test_observability.py::test_trace_propagation"]
      code_markers: ["@req:SG-OBS-001"]
      runtime_assertions: []
  - id: SG-MET-001
    title: Metrics bắt buộc: a2a_requests_total
