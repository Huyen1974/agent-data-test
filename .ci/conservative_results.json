{
  "all_checks_pass": true,
  "formatted_content": "# \ud83d\udcdc File Quy t\u1eafc D\u1ef1 \u00e1n: RULES_agent-data-langroid.md (Version 1.2)\nC\u1eadp nh\u1eadt: August 07, 2025 (Phi\u00ean b\u1ea3n tu\u00e2n th\u1ee7 Hi\u1ebfn ph\u00e1p v1.11e v\u00e0 c\u00e1c Lu\u1eadt li\u00ean quan)\n\u26d4 QUY T\u1eaeC CURSOR \u2013 D\u1ef0 \u00c1N AGENT DATA LANGROID (B\u1ea3n Ho\u00e0n Ch\u1ec9nh)\nT\u00e0i li\u1ec7u n\u00e0y l\u00e0 ngu\u1ed3n ch\u00e2n l\u00fd duy nh\u1ea5t cho m\u1ecdi ho\u1ea1t \u0111\u1ed9ng c\u1ee7a b\u1ea1n. M\u1ecdi h\u00e0nh \u0111\u1ed9ng ph\u1ea3i tu\u00e2n th\u1ee7 nghi\u00eam ng\u1eb7t c\u00e1c quy t\u1eafc d\u01b0\u1edbi \u0111\u00e2y.\n\n### 1. B\u1ed1i c\u1ea3nh & Ph\u1ea1m vi V\u1eadn h\u00e0nh\nB\u1ea1n ch\u1ec9 l\u00e0m vi\u1ec7c trong c\u00e1c b\u1ed1i c\u1ea3nh \u0111\u00e3 \u0111\u01b0\u1ee3c \u0111\u1ecbnh ngh\u0129a d\u01b0\u1edbi \u0111\u00e2y.\n- \u0110\u01b0\u1eddng d\u1eabn D\u1ef1 \u00e1n Duy nh\u1ea5t:\n  - `/Users/nmhuyen/Documents/Manual Deploy/agent-data-langroid` \n- Project Google Cloud Duy nh\u1ea5t:\n  - `github-chatgpt-ggcloud` \n- Service Account Duy nh\u1ea5t:\n  - `chatgpt-deployer@github-chatgpt-ggcloud.iam.gserviceaccount.com` \n- C\u00e1c Repository trong Ph\u1ea1m vi:\n  - `agent-data-test` (Repo ph\u00e1t tri\u1ec3n & ki\u1ec3m th\u1eed) \n  - `agent-data-production` (Repo s\u1ea3n ph\u1ea9m) \n  - `chatgpt-githubnew` (Repo trung t\u00e2m qu\u1ea3n l\u00fd secrets) \n- Ki\u1ec3m tra nhanh WIF: Tr\u01b0\u1edbc khi \u0111\u1ea9y c\u00e1c thay \u0111\u1ed5i li\u00ean quan \u0111\u1ebfn quy\u1ec1n h\u1ea1n, b\u1ea1n n\u00ean ch\u1ea1y l\u1ec7nh sau tr\u00ean m\u00e1y c\u1ee5c b\u1ed9 \u0111\u1ec3 m\u00f4 ph\u1ecfng v\u00e0 ki\u1ec3m tra c\u00e1c \u0111i\u1ec1u ki\u1ec7n WIF: \n\n```bash\ngcloud auth application-default login --impersonate-service-account=$GCP_SERVICE_ACCOUNT\n```\n\n### 2. Quy t\u1eafc Qu\u1ea3n l\u00fd H\u1ea1 t\u1ea7ng (Terraform)\n\n#### 2.1 Quy \u01b0\u1edbc \u0111\u1eb7t t\u00ean Bucket\n- M\u1ecdi bucket do Terraform qu\u1ea3n l\u00fd ho\u1eb7c kh\u1edfi t\u1ea1o m\u1edbi B\u1eaeT BU\u1ed8C tu\u00e2n th\u1ee7 \u0111\u1ecbnh d\u1ea1ng:\n`<standard-prefix>-agent-data-<purpose>-<env>`\n- `standard-prefix`: c\u1ed1 \u0111\u1ecbnh l\u00e0 `huyen1974`.\n- K\u00fd t\u1ef1: b\u1eaft bu\u1ed9c d\u00f9ng d\u1ea5u g\u1ea1ch ngang (-), c\u1ea5m tuy\u1ec7t \u0111\u1ed1i d\u1ea5u g\u1ea1ch d\u01b0\u1edbi (_).\n- `purpose`: m\u00f4 t\u1ea3 m\u1ee5c \u0111\u00edch bucket (v\u00ed d\u1ee5: `tfstate`, `artifacts`, `backup`).\n- `env`: m\u00f4i tr\u01b0\u1eddng \u00e1p d\u1ee5ng (`dev`, `test`, `prod`).\n\n#### 2.2 Danh s\u00e1ch bucket c\u1ee5 th\u1ec3\n\n| T\u00ean Bucket | M\u1ee5c \u0111\u00edch (`<purpose>`) | M\u00f4i tr\u01b0\u1eddng (`<env>`) |\n| :-- | :-- | :-- |\n| `huyen1974-agent-data-artifacts-test` | `artifacts` | `test` |\n| `huyen1974-agent-data-artifacts-production` | `artifacts` | `production` |\n| `huyen1974-agent-data-knowledge-test` | `knowledge` | `test` |\n| `huyen1974-agent-data-knowledge-production` | `knowledge` | `production` |\n| `huyen1974-agent-data-logs-test` | `logs` | `test` |\n| `huyen1974-agent-data-logs-production` | `logs` | `production` |\n| `huyen1974-agent-data-qdrant-snapshots-test` | `qdrant-snapshots` | `test` |\n| `huyen1974-agent-data-qdrant-snapshots-production` | `qdrant-snapshots` | `production` |\n| `huyen1974-agent-data-source-test` | `source` | `test` |\n| `huyen1974-agent-data-source-production` | `source` | `production` |\n| `huyen1974-agent-data-tfstate-test` | `tfstate` | `test` |\n| `huyen1974-agent-data-tfstate-production` | `tfstate` | `production` |\n| `huyen1974-agent-data-backup-test` | `backup` | `test` |\n| `huyen1974-agent-data-backup-production` | `backup` | `production` |\n\n#### 2.3 Quy \u0111\u1ecbnh v\u1ec1 b\u1ea3o m\u1eadt & truy c\u1eadp\n- Uniform Bucket-Level Access (UBLA): t\u1ea5t c\u1ea3 bucket m\u1edbi B\u1eaeT BU\u1ed8C b\u1eadt UBLA \u0111\u1ec3 tu\u00e2n th\u1ee7 Hi\u1ebfn ph\u00e1p (HP-02) v\u00e0 TF-LAW (\u00a74.3).\n- Legacy bucket: c\u00e1c bucket \u0111\u01b0\u1ee3c t\u1ea1o tr\u01b0\u1edbc khi Hi\u1ebfn ph\u00e1p c\u00f3 hi\u1ec7u l\u1ef1c nh\u01b0ng ch\u01b0a b\u1eadt UBLA \u0111\u01b0\u1ee3c x\u1ebfp lo\u1ea1i \"legacy\" v\u00e0 s\u1ebd \u0111\u01b0\u1ee3c x\u1eed l\u00fd theo n\u1ee3 k\u1ef9 thu\u1eadt TD-TF-01.\n\n#### 2.4 L\u01b0u \u00fd v\u1ec1 c\u1eadp nh\u1eadt & b\u1ea3o tr\u00ec\n- Khi b\u1ed5 sung ho\u1eb7c thay \u0111\u1ed5i bucket, b\u1eaft bu\u1ed9c c\u1eadp nh\u1eadt b\u1ea3ng danh s\u00e1ch \u1edf m\u1ee5c 2.2 \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o Terraform state v\u00e0 t\u00e0i li\u1ec7u lu\u00f4n \u0111\u1ed3ng b\u1ed9.\n- M\u1ecdi thay \u0111\u1ed5i li\u00ean quan \u0111\u1ebfn bucket ph\u1ea3i \u0111\u01b0\u1ee3c commit k\u00e8m l\u00fd do v\u00e0 li\u00ean k\u1ebft t\u1edbi issue ho\u1eb7c ticket k\u1ef9 thu\u1eadt li\u00ean quan.\n\n### 3. Qu\u1ea3n l\u00fd Artifacts & Docker Images\n- N\u01a1i l\u01b0u tr\u1eef: M\u1ecdi Docker images, Cloud Functions v\u00e0 c\u00e1c artifact kh\u00e1c ph\u1ea3i \u0111\u01b0\u1ee3c l\u01b0u tr\u1eef tr\u00ean Google Artifact Registry.\n- Ph\u00e2n t\u00e1ch m\u00f4i tr\u01b0\u1eddng: S\u1ebd c\u00f3 c\u00e1c repository ri\u00eang bi\u1ec7t trong Artifact Registry cho m\u1ed7i m\u00f4i tr\u01b0\u1eddng: `agent-data-test` v\u00e0 `agent-data-production` .\n- Ch\u00ednh s\u00e1ch L\u01b0u gi\u1eef (Retention): Vi\u1ec7c l\u01b0u gi\u1eef artifact B\u1eaeT BU\u1ed8C ph\u1ea3i tu\u00e2n th\u1ee7 quy tr\u00ecnh 2 giai \u0111o\u1ea1n:\n  - 14 ng\u00e0y: C\u00e1c artifact s\u1ebd \u0111\u01b0\u1ee3c t\u1ef1 \u0111\u1ed9ng \u0111\u00e1nh d\u1ea5u l\u00e0 \"stale\" (c\u0169) \u0111\u1ec3 c\u1ea3nh b\u00e1o s\u1edbm.\n  - 30 ng\u00e0y: M\u1ed9t quy tr\u00ecnh t\u1ef1 \u0111\u1ed9ng s\u1ebd t\u1ea1o GitHub Issue [CLEANUP] \u0111\u1ec3 y\u00eau c\u1ea7u ph\u00ea duy\u1ec7t d\u1ecdn d\u1eb9p. Vi\u1ec7c x\u00f3a b\u1ecf ch\u1ec9 \u0111\u01b0\u1ee3c th\u1ef1c hi\u1ec7n th\u1ee7 c\u00f4ng sau khi Issue \u0111\u01b0\u1ee3c \u0111\u00f3ng l\u1ea1i.\n  - B\u00e1o c\u00e1o v\u00e0 C\u1ea3nh b\u00e1o: M\u1ed9t b\u00e1o c\u00e1o t\u1ef1 \u0111\u1ed9ng h\u00e0ng tu\u1ea7n qua Slack s\u1ebd t\u1ed5ng h\u1ee3p s\u1ed1 l\u01b0\u1ee3ng artifact \u0111ang \u0111\u01b0\u1ee3c \u0111\u00e1nh d\u1ea5u \"stale\". B\u00e1o c\u00e1o n\u00e0y B\u1eaeT BU\u1ed8C ph\u1ea3i \u0111\u01b0\u1ee3c c\u1ea5u h\u00ecnh v\u1edbi m\u1ed9t ng\u01b0\u1ee1ng c\u1ea3nh b\u00e1o (v\u00ed d\u1ee5: stale_count < 5) v\u00e0 s\u1ebd g\u1eedi m\u1ed9t c\u1ea3nh b\u00e1o \u0111\u1eb7c bi\u1ec7t n\u1ebfu s\u1ed1 l\u01b0\u1ee3ng v\u01b0\u1ee3t ng\u01b0\u1ee1ng n\u00e0y. \n\n### 4. Qu\u1ea3n l\u00fd D\u1eef li\u1ec7u (Firestore & Metadata)\n\n#### 4.1. Quy t\u1eafc Qu\u1ea3n l\u00fd Qdrant\n- T\u00ean Cluster: Cluster b\u1ea1n l\u00e0m vi\u1ec7c c\u00f3 t\u00ean l\u00e0 `agent-data-vector-dev-useast4`.\n- T\u00ean Collection: T\u00ean collection B\u1eaeT BU\u1ed8C ph\u1ea3i theo \u0111\u1ecbnh d\u1ea1ng `<env>_documents` (v\u00ed d\u1ee5: `test_documents`, `production_documents`).\n- V\u1eadn Qu\u1ea3n l\u00fd Tr\u1ea1ng th\u00e1i Cluster: M\u1ecdi t\u00e1c v\u1ee5 v\u1eadn h\u00e0nh (v\u00ed d\u1ee5: t\u1ea1m d\u1eebng cluster \u0111\u1ec3 ti\u1ebft ki\u1ec7m chi ph\u00ed) B\u1eaeT BU\u1ed8C ph\u1ea3i \u0111\u01b0\u1ee3c th\u1ef1c hi\u1ec7n th\u00f4ng qua Cloud Function `manage_qdrant`. C\u1ee5 th\u1ec3, khi c\u1ea7n t\u1ea1m d\u1eebng cluster, b\u1ea1n ph\u1ea3i g\u1ecdi \u0111\u1ebfn action `stop`, v\u00ec action n\u00e0y \u0111\u00e3 bao g\u1ed3m b\u01b0\u1edbc t\u1ea1o snapshot an to\u00e0n theo y\u00eau_c\u1ea7u c\u1ee7a QD-LAW \u00a74.2.\n- Vai tr\u00f2 c\u1ee7a Firestore: Firestore \u0111\u01b0\u1ee3c s\u1eed d\u1ee5ng cho hai m\u1ee5c \u0111\u00edch ch\u00ednh:\n1.\tL\u01b0u tr\u1eef \nSession Memory cho Agent.\n2.\tL\u01b0u tr\u1eef \nMetadata cho c\u00e1c vector trong Qdrant.\n- Nguy\u00ean t\u1eafc \u0110\u1ed3ng b\u1ed9 B\u1ea5t bi\u1ebfn: M\u1ecdi thao t\u00e1c ghi ho\u1eb7c c\u1eadp nh\u1eadt vector v\u00e0o Qdrant B\u1eaeT BU\u1ed8C ph\u1ea3i \u0111\u01b0\u1ee3c th\u1ef1c hi\u1ec7n song song v\u1edbi vi\u1ec7c ghi ho\u1eb7c c\u1eadp nh\u1eadt metadata t\u01b0\u01a1ng \u1ee9ng v\u00e0o Firestore .\n- Trong tr\u01b0\u1eddng-h\u1ee3p quy tr\u00ecnh \u0111\u1ed3ng b\u1ed9 n\u00e0y g\u1eb7p l\u1ed7i, h\u1ec7 th\u1ed1ng ph\u1ea3i c\u00f3 c\u01a1 ch\u1ebf g\u1eedi c\u1ea3nh b\u00e1o ngay l\u1eadp t\u1ee9c cho Owner (v\u00ed d\u1ee5: qua Slack) \u0111\u1ec3 x\u1eed l\u00fd th\u1ee7 c\u00f4ng.\n- C\u1ea5u tr\u00fac Metadata: C\u1ea5u tr\u00fac chi ti\u1ebft c\u1ee7a metadata v\u00e0 c\u00e1c nh\u00e3n s\u1ebd \u0111\u01b0\u1ee3c \u0111\u1ecbnh ngh\u0129a trong c\u00e1c t\u00e0i li\u1ec7u thi\u1ebft k\u1ebf chuy\u00ean s\u00e2u. Nhi\u1ec7m v\u1ee5 c\u1ee7a b\u1ea1n l\u00e0 tu\u00e2n th\u1ee7 c\u00e1c c\u1ea5u tr\u00fac \u0111\u00e3 \u0111\u01b0\u1ee3c \u0111\u1ecbnh ngh\u0129a trong m\u00e3 ngu\u1ed3n (v\u00ed d\u1ee5: Pydantic models).\n- Ch\u00ednh s\u00e1ch Skip H\u1ee3p l\u1ec7: Trong tr\u01b0\u1eddng h\u1ee3p cluster Qdrant \u0111\u01b0\u1ee3c t\u1ea1m d\u1eebng (tr\u1ea1ng th\u00e1i SUSPENDED), c\u00e1c job CI/CD ph\u1ee5 thu\u1ed9c v\u00e0o Qdrant \u0111\u01b0\u1ee3c ph\u00e9p b\u1ecf qua (skip). Ngo\u1ea1i l\u1ec7 n\u00e0y ch\u1ec9 h\u1ee3p l\u1ec7 n\u1ebfu Pull Request KH\u00d4NG ch\u1ee9a thay \u0111\u1ed5i trong c\u00e1c \u0111\u01b0\u1eddng d\u1eabn file \"li\u00ean quan \u0111\u1ebfn Qdrant\" (tham chi\u1ebfu GLOBAL RULES \u2013 m\u1ee5c 2.3). Tr\u01b0\u1edbc khi th\u1ef1c thi c\u00e1c t\u00e1c v\u1ee5 y\u00eau c\u1ea7u Qdrant, Owner ph\u1ea3i c\u00f3 tr\u00e1ch nhi\u1ec7m k\u00edch ho\u1ea1t l\u1ea1i cluster.\n\n### 5. Quy t\u1eafc CI/CD & GitHub\n\n#### 5.1 Ki\u1ec3m so\u00e1t Lockfile\n- Lockfile (`requirements.txt`) B\u1eaeT BU\u1ed8C \u0111\u01b0\u1ee3c t\u1ea1o b\u1eb1ng:\n\n```bash\npip-compile --no-upgrade\n```\n\n- CI s\u1ebd ki\u1ec3m tra b\u1eb1ng:\n\n```bash\ngit diff --exit-code requirements.txt\n```\n\n\u0111\u1ec3 \u0111\u1ea3m b\u1ea3o file kh\u00f4ng b\u1ecb ch\u1ec9nh s\u1eeda th\u1ee7 c\u00f4ng.\n\n#### 5.2 Pre-commit Hooks\n- M\u1ecdi commit B\u1eaeT BU\u1ed8C ph\u1ea3i v\u01b0\u1ee3t qua c\u00e1c hook \u0111\u00e3 \u0111\u01b0\u1ee3c \u0111\u1ecbnh ngh\u0129a trong `.pre-commit-config.yaml`, bao g\u1ed3m:\n  - `black`, `ruff`, `trufflehog`, `manifest-drift`.\n\n#### 5.3 Quy \u0111\u1ecbnh v\u1ec1 Workflow T\u1ed5ng h\u1ee3p (Pass Gate)\n- Repository ch\u1ec9 \u0111\u01b0\u1ee3c ph\u00e9p c\u00f3 duy nh\u1ea5t m\u1ed9t workflow \u0111\u01b0\u1ee3c trigger tr\u1ef1c ti\u1ebfp l\u00e0: `.github/workflows/pass-gate.yml`\n- C\u00e1c workflow kh\u00e1c (`lint-only.yml`, `terraform-plan.yml`, `secret-scan.yml`, `manifest-drift.yml`, `agent-e2e.yml`) B\u1eaeT BU\u1ed8C ph\u1ea3i \u0111\u01b0\u1ee3c c\u1ea5u h\u00ecnh v\u1edbi `on: workflow_call` v\u00e0 ch\u1ec9 \u0111\u01b0\u1ee3c k\u00edch ho\u1ea1t b\u1edfi `pass-gate.yml`.\n- C\u00e1c workflow \u0111\u01b0\u1ee3c g\u1ecdi qua `on: workflow_call` C\u1ea4M TUY\u1ec6T \u0110\u1ed0I s\u1eed d\u1ee5ng `secrets: inherit`. Workflow `pass-gate.yml` ch\u1ec9 \u0111\u01b0\u1ee3c ph\u00e9p truy\u1ec1n c\u00e1c gi\u00e1 tr\u1ecb \u0111\u1ea7u v\u00e0o (`inputs`) ho\u1eb7c bi\u1ebfn m\u00f4i tr\u01b0\u1eddng (`env`) t\u1ed1i thi\u1ec3u c\u1ea7n thi\u1ebft, v\u00e0 kh\u00f4ng \u0111\u01b0\u1ee3c truy\u1ec1n secrets cho c\u00e1c job \u0111\u01b0\u1ee3c k\u00edch ho\u1ea1t b\u1edfi PR t\u1eeb fork.\n\n#### 5.4 Branch Protection & Status Check\n- Ch\u1ec9 thi\u1ebft l\u1eadp duy nh\u1ea5t 1 status check Required: Pass Gate\n- Kh\u00f4ng \u0111\u1ec3 nhi\u1ec1u check ri\u00eang l\u1ebb nh\u1eb1m tr\u00e1nh \u0111\u00e1nh gi\u00e1 sai tr\u1ea1ng th\u00e1i t\u1ed5ng th\u1ec3.\n- Ghi ch\u00fa: T\u00ean status check \"Pass Gate\" l\u00e0 c\u1ed1 \u0111\u1ecbnh. M\u1ecdi thay \u0111\u1ed5i \u0111\u1ed1i v\u1edbi t\u00ean job ho\u1eb7c context trong workflow `pass-gate.yml` B\u1eaeT BU\u1ed8C ph\u1ea3i \u0111\u01b0\u1ee3c c\u1eadp nh\u1eadt \u0111\u1ed3ng b\u1ed9 trong c\u00e0i \u0111\u1eb7t Branch Protection \u0111\u1ec3 tr\u00e1nh t\u00ecnh tr\u1ea1ng merge b\u1ecb ch\u1eb7n ho\u1eb7c \"xanh gi\u1ea3\".\n\n#### 5.5 Chi ti\u1ebft Job Gate v\u00e0 X\u1eed l\u00fd ng\u1eef c\u1ea3nh\n- Job t\u1ed5ng h\u1ee3p trong `pass-gate.yml` PH\u1ea2I ch\u1ea1y v\u1edbi \u0111i\u1ec1u ki\u1ec7n: `if: ${{ always() }}`.\n- Kh\u00e1i ni\u1ec7m `REQUIRED_JOBS`: M\u1ed9t danh s\u00e1ch c\u00e1c job con b\u1eaft bu\u1ed9c ph\u1ea3i th\u00e0nh c\u00f4ng \u0111\u01b0\u1ee3c x\u00e1c \u0111\u1ecbnh d\u1ef1a tr\u00ean ng\u1eef c\u1ea3nh c\u1ee7a Pull Request:\n  - PR t\u1eeb nh\u00e1nh n\u1ed9i b\u1ed9: Y\u00eau c\u1ea7u t\u1ea5t c\u1ea3 c\u00e1c job ch\u00ednh (`lint`, `secret-scan`, `manifest-drift`, `terraform-plan`, `agent-e2e`).\n  - PR t\u1eeb fork: Kh\u00f4ng y\u00eau c\u1ea7u c\u00e1c job c\u1ea7n secrets/WIF (`terraform-plan`, `agent-e2e`).\n- Job gate PH\u1ea2I FAIL n\u1ebfu b\u1ea5t k\u1ef3 job n\u00e0o trong danh s\u00e1ch `REQUIRED_JOBS` c\u00f3 conclusion kh\u00e1c `success`. C\u00e1c job `skipped` kh\u00f4ng thu\u1ed9c `REQUIRED_JOBS` (v\u00ed d\u1ee5: do PR t\u1eeb fork) s\u1ebd \u0111\u01b0\u1ee3c b\u1ecf qua.\n- Ghi ch\u00fa tri\u1ec3n khai: Vi\u1ec7c x\u00e1c \u0111\u1ecbnh PR t\u1eeb fork trong workflow c\u00f3 th\u1ec3 \u0111\u01b0\u1ee3c th\u1ef1c hi\u1ec7n b\u1eb1ng \u0111i\u1ec1u ki\u1ec7n sau: `if: ${{ github.event.pull_request.head.repo.fork == true }}`. D\u1ef1a v\u00e0o \u0111i\u1ec1u ki\u1ec7n n\u00e0y, danh s\u00e1ch `REQUIRED_JOBS` s\u1ebd \u0111\u01b0\u1ee3c \u0111i\u1ec1u ch\u1ec9nh \u0111\u1ec3 lo\u1ea1i b\u1ecf c\u00e1c job c\u1ea7n secrets/WIF.\n\n#### 5.6 C\u1ea5u h\u00ecnh Concurrency v\u00e0 Quy t\u1eafc X\u00e1c minh\n- File `pass-gate.yml` B\u1eaeT BU\u1ed8C ph\u1ea3i c\u00f3 \u0111o\u1ea1n sau \u0111\u1ec3 h\u1ee7y c\u00e1c l\u1ea7n ch\u1ea1y CI c\u0169 khi c\u00f3 commit m\u1edbi, tr\u00e1nh l\u00e3ng ph\u00ed t\u00e0i nguy\u00ean v\u00e0 t\u00ecnh tr\u1ea1ng \u0111ua tr\u1ea1ng th\u00e1i:\n\n```yaml\nconcurrency:\n  group: pass-gate-${{ github.ref }}\n  cancel-in-progress: true\n```\n\n- Ghi ch\u00fa Quan tr\u1ecdng: Do c\u00f3 thi\u1ebft l\u1eadp `cancel-in-progress: true`, c\u00f3 th\u1ec3 c\u00f3 nhi\u1ec1u CI run \u0111\u01b0\u1ee3c t\u1ea1o ra r\u1ed3i b\u1ecb h\u1ee7y cho c\u00f9ng m\u1ed9t commit. V\u00ec v\u1eady, b\u1ea1n B\u1eaeT BU\u1ed8C ph\u1ea3i tu\u00e2n th\u1ee7 nguy\u00ean v\u0103n quy tr\u00ecnh Post-push CI Verification (GLOBAL RULES \u2013 m\u1ee5c 2.1): t\u00ecm \u0111\u00fang `RUN_ID` c\u1ee7a commit SHA cu\u1ed1i c\u00f9ng v\u00e0 ch\u1ec9 theo d\u00f5i run \u0111\u00f3 \u0111\u1ec3 tr\u00e1nh \u0111\u1ecdc nh\u1ea7m k\u1ebft qu\u1ea3 t\u1eeb m\u1ed9t run \u0111\u00e3 b\u1ecb h\u1ee7y.\n\n#### 5.7 Terraform Init Chu\u1ea9n\n- Trong job plan:\n\n```bash\nterraform init -reconfigure -backend-config=terraform/backend.hcl\n```\n\n- Trong job lint-only:\n\n```bash\nterraform init -backend=false && terraform validate -no-color\n```\n\n- C\u1ea5m m\u1ecdi backend auto \u0111\u1ec3 tr\u00e1nh l\u1ed7i \"bucket not set\".\n\n#### 5.8 Quy t\u1eafc v\u1ec1 Shell an to\u00e0n & continue-on-error\n- Tu\u00e2n th\u1ee7 nguy\u00ean v\u0103n GLOBAL RULES \u2013 m\u1ee5c 2.2. C\u1ea5m tuy\u1ec7t \u0111\u1ed1i `continue-on-error` (ngo\u1ea1i tr\u1eeb b\u01b0\u1edbc \"auth fallback\" n\u1ebfu c\u00f3), b\u1eaft bu\u1ed9c s\u1eed d\u1ee5ng `shell: bash -euo pipefail {0}` cho t\u1ea5t c\u1ea3 c\u00e1c b\u01b0\u1edbc `run:`.\n\n##### 5.8.1 Policy Guard cho Trigger v\u00e0 C\u1ea5u h\u00ecnh Job\nWorkflow `pass-gate.yml` B\u1eaeT BU\u1ed8C ph\u1ea3i c\u00f3 m\u1ed9t job `workflow-policy-guard` ch\u1ea1y \u0111\u1ea7u ti\u00ean. Job n\u00e0y c\u00f3 c\u00e1c tr\u00e1ch nhi\u1ec7m sau:\n- S\u1eed d\u1ee5ng c\u00e1c c\u00f4ng c\u1ee5 nh\u01b0 `actionlint` ho\u1eb7c `grep` \u0111\u1ec3 ki\u1ec3m tra v\u00e0 l\u00e0m th\u1ea5t b\u1ea1i (fail) workflow n\u1ebfu ph\u00e1t hi\u1ec7n b\u1ea5t k\u1ef3 file workflow n\u00e0o kh\u00e1c (ngo\u00e0i `pass-gate.yml`) c\u00f3 ch\u1ee9a trigger `on: push` ho\u1eb7c `on: pull_request`.\n- Ki\u1ec3m tra v\u00e0 l\u00e0m th\u1ea5t b\u1ea1i workflow n\u1ebfu ph\u00e1t hi\u1ec7n b\u1ea5t k\u1ef3 job n\u00e0o trong danh s\u00e1ch `REQUIRED_JOBS` (\u0111\u1ecbnh ngh\u0129a t\u1ea1i m\u1ee5c 5.5) c\u00f3 s\u1eed d\u1ee5ng c\u00e1c \u0111i\u1ec1u ki\u1ec7n `paths:`, `paths-ignore:`, ho\u1eb7c `if:` c\u00f3 kh\u1ea3 n\u0103ng l\u00e0m job \u0111\u00f3 b\u1ecb b\u1ecf qua (skip) m\u1ed9t c\u00e1ch kh\u00f4ng h\u1ee3p l\u1ec7.\n- Ki\u1ec3m tra v\u00e0 l\u00e0m th\u1ea5t b\u1ea1i workflow n\u1ebfu ph\u00e1t hi\u1ec7n b\u1ea5t k\u1ef3 job n\u00e0o trong danh s\u00e1ch `REQUIRED_JOBS` c\u00f3 ch\u1ee9a `continue-on-error: true` (ngo\u1ea1i tr\u1eeb c\u00e1c b\u01b0\u1edbc \"auth fallback\" \u0111\u00e3 \u0111\u01b0\u1ee3c cho ph\u00e9p).\n\n##### 5.8.2 File backend.hcl B\u1eaft bu\u1ed9c\nM\u00e3 ngu\u1ed3n Terraform B\u1eaeT BU\u1ed8C ph\u1ea3i c\u00f3 file `terraform/backend.hcl` \u0111\u01b0\u1ee3c commit v\u00e0o repository. File n\u00e0y \u0111\u1ecbnh ngh\u0129a c\u1ea5u h\u00ecnh backend chu\u1ea9n v\u00e0 l\u00e0 ngu\u1ed3n ch\u00e2n l\u00fd duy nh\u1ea5t cho vi\u1ec7c kh\u1edfi t\u1ea1o Terraform.\n\n##### 5.8.3 Kh\u00f3a c\u1ee9ng Permissions c\u1ee7a Workflow\nM\u1ecdi workflow B\u1eaeT BU\u1ed8C ph\u1ea3i \u0111\u01b0\u1ee3c c\u1ea5u h\u00ecnh v\u1edbi quy\u1ec1n h\u1ea1n \u1edf m\u1ee9c t\u1ed1i thi\u1ec3u:\n\n```yaml\npermissions: { contents: read }\n```\n\nCh\u1ec9 nh\u1eefng job th\u1ef1c s\u1ef1 c\u1ea7n OIDC m\u1edbi \u0111\u01b0\u1ee3c c\u1ea5p th\u00eam `id-token: write`. C\u1ea5m tuy\u1ec7t \u0111\u1ed1i s\u1eed d\u1ee5ng `pull_request_target` trong c\u00e1c repo con.\n\n#### 5.9 Post-push CI Verification (Chu\u1ea9n h\u00f3a Log v\u00e0 Artifact)\nQuy tr\u00ecnh n\u00e0y tu\u00e2n th\u1ee7 nguy\u00ean v\u0103n GLOBAL RULES \u2013 m\u1ee5c 2.1, v\u1edbi c\u00e1c chi ti\u1ebft k\u1ef9 thu\u1eadt \u0111\u01b0\u1ee3c l\u00e0m r\u00f5 nh\u01b0 sau:\n- X\u00e1c \u0111\u1ecbnh L\u1ed7i: Sau m\u1ed7i l\u1ea7n push/PR, CI s\u1ebd ki\u1ec3m tra c\u00e1c run c\u00f3 `headSha` tr\u00f9ng v\u1edbi commit hi\u1ec7n t\u1ea1i. N\u1ebfu c\u00f3 run th\u1ea5t b\u1ea1i (`failure`, `cancelled`, `timed_out`), quy tr\u00ecnh t\u1ef1 s\u1eeda l\u1ed7i s\u1ebd \u0111\u01b0\u1ee3c k\u00edch ho\u1ea1t.\n- L\u01b0u v\u00e0 Tr\u00ecnh b\u00e0y Log:\n  - Khi m\u1ed9t v\u00f2ng s\u1eeda l\u1ed7i b\u1eaft \u0111\u1ea7u, log c\u1ee7a job th\u1ea5t b\u1ea1i B\u1eaeT BU\u1ed8C ph\u1ea3i \u0111\u01b0\u1ee3c l\u01b0u v\u00e0o m\u1ed9t file theo \u0111\u1ecbnh d\u1ea1ng: `.ci/${SHA}.autofix<N>.log` (v\u1edbi N l\u00e0 1 ho\u1eb7c 2).\n  - File log n\u00e0y B\u1eaeT BU\u1ed8C ph\u1ea3i \u0111\u01b0\u1ee3c t\u1ea3i l\u00ean (upload) l\u00e0m artifact c\u1ee7a CI run \u0111\u00f3.\n  - C\u1ea4M TUY\u1ec6T \u0110\u1ed0I commit c\u00e1c file log v\u00e0o repository. Th\u01b0 m\u1ee5c `.ci/` ph\u1ea3i \u0111\u01b0\u1ee3c th\u00eam v\u00e0o file `.gitignore`.\n- Quy tr\u00ecnh T\u1ef1 s\u1eeda l\u1ed7i (Auto-fix):\n  - V\u00f2ng 1: Commit b\u1ea3n s\u1eeda l\u1ed7i v\u1edbi message b\u1eaft \u0111\u1ea7u b\u1eb1ng `[AUTOFIX-1] <root-cause>`.\n  - V\u00f2ng 2: N\u1ebfu v\u1eabn th\u1ea5t b\u1ea1i, l\u1eb7p l\u1ea1i quy tr\u00ecnh v\u1edbi commit message `[AUTOFIX-2] <root-cause>`.\n  - Sau 2 v\u00f2ng n\u1ebfu v\u1eabn th\u1ea5t b\u1ea1i, Cursor ph\u1ea3i d\u1eebng l\u1ea1i v\u00e0 t\u1ea1o issue v\u1edbi ti\u00eau \u0111\u1ec1: \ud83d\uded1 CI still failing after 2 auto-fixes. N\u1ed9i dung issue ph\u1ea3i \u0111\u00ednh k\u00e8m link \u0111\u1ebfn CI run th\u1ea5t b\u1ea1i cu\u1ed1i c\u00f9ng.\n\n#### 5.10 Pass-gate Merge Policy\n- Pull Request ch\u1ec9 \u0111\u01b0\u1ee3c merge khi workflow `pass-gate.yml` XANH HO\u00c0N TO\u00c0N.\n\n#### 5.11 Tag cho Production Release\n- Tag PH\u1ea2I theo \u0111\u1ecbnh d\u1ea1ng:\n\n```text\nvX.Y.Z\n```\n\n(v\u00ed d\u1ee5: `v1.2.3`)\n\n#### 5.12 C\u1ea3nh b\u00e1o N\u1ee3 K\u1ef9 thu\u1eadt (t\u1ea1m th\u1eddi)\n- Cho \u0111\u1ebfn khi dashboard `agent-data-ops` ho\u00e0n thi\u1ec7n (HP-OBS-01), c\u00e1c CI ch\u00ednh PH\u1ea2I in ra:\n\n```bash\n::warning:: Gi\u00e1m s\u00e1t ch\u01b0a ho\u00e0n ch\u1ec9nh \u2013 vui l\u00f2ng theo d\u00f5i th\u1ee7 c\u00f4ng.\n```\n\n#### 5.13 Chu\u1ea9n ho\u00e1 M\u00fai gi\u1edd CI/CD (UTC)\n- M\u1ecdi ki\u1ec3m tra CI/CD, x\u00e1c th\u1ef1c tr\u1ea1ng th\u00e1i pass-gate, ph\u00e2n t\u00edch l\u1ecbch s\u1eed push/pull request B\u1eaeT BU\u1ed8C ph\u1ea3i \u0111\u01b0\u1ee3c th\u1ef1c hi\u1ec7n theo chu\u1ea9n m\u00fai gi\u1edd UTC.\n- Quy \u0111\u1ecbnh n\u00e0y nh\u1eb1m tr\u00e1nh s\u1ef1 sai l\u1ec7ch gi\u1eefa th\u1eddi gian ghi nh\u1eadn c\u1ee7a GitHub Actions runner v\u00e0 c\u00e1c l\u1ec7nh ki\u1ec3m tra b\u1eb1ng CLI nh\u01b0 `gh run view`, `gh run list`.\n- N\u1ed9i dung k\u1ebf th\u1eeba t\u1eeb t\u00e0i li\u1ec7u ch\u00ednh th\u1ee9c: PLAN MERGE TO LAW 1.12 (M\u1ee5c 4.1 v\u00e0 4.2).\n\n### 6. Qu\u1ea3n l\u00fd Secrets (C\u1ef0C K\u1ef2 QUAN TR\u1eccNG)\n- Ngu\u1ed3n Ch\u00e2n l\u00fd: Google Secret Manager l\u00e0 ngu\u1ed3n duy nh\u1ea5t cho gi\u00e1 tr\u1ecb c\u1ee7a secrets.\n- C\u01a1 ch\u1ebf \u0110\u1ed3ng b\u1ed9: Secrets tr\u00ean GitHub \u0111\u01b0\u1ee3c qu\u1ea3n l\u00fd T\u1eacP TRUNG. M\u1ed9t workflow \n`sync-secrets.yml` t\u1ea1i repo `chatgpt-githubnew` l\u00e0 quy tr\u00ecnh DUY NH\u1ea4T \u0111\u01b0\u1ee3c ph\u00e9p ghi (`secrets:write`) secrets l\u00ean c\u00e1c repo `agent-data-test` v\u00e0 `agent-data-production` .\n- Nhi\u1ec7m v\u1ee5 c\u1ee7a Cursor: B\u1ea1n KH\u00d4NG \u0110\u01af\u1ee2C PH\u00c9P t\u1ea1o, s\u1eeda, ho\u1eb7c x\u00f3a secrets tr\u1ef1c ti\u1ebfp tr\u00ean `agent-data-test` ho\u1eb7c `agent-data-production`. Quy tr\u00ecnh X\u1eed l\u00fd S\u1ef1 c\u1ed1 (Fallback): Trong tr\u01b0\u1eddng h\u1ee3p workflow `sync-secrets.yml` g\u1eb7p s\u1ef1 c\u1ed1 k\u00e9o d\u00e0i (>24h), vi\u1ec7c c\u1eadp nh\u1eadt th\u1ee7 c\u00f4ng s\u1ebd \u0111\u01b0\u1ee3c th\u1ef1c hi\u1ec7n theo quy tr\u00ecnh fallback \u0111\u00e3 quy \u0111\u1ecbnh t\u1ea1i GH-LAW \u00a75.5.\n- Danh s\u00e1ch Secrets: D\u01b0\u1edbi \u0111\u00e2y l\u00e0 danh s\u00e1ch c\u00e1c secret b\u1ea1n s\u1ebd l\u00e0m vi\u1ec7c.\n\n| M\u1ee5c \u0111\u00edch | T\u00ean Secret tr\u00ean GitHub | Ghi ch\u00fa |\n| :-- | :-- | :-- |\n| GCP Project ID | `GCP_PROJECT_ID` | Gi\u00e1 tr\u1ecb: `github-chatgpt-ggcloud` |\n| Deployer SA | `GCP_SERVICE_ACCOUNT` | Gi\u00e1 tr\u1ecb: `chatgpt-deployer@...` |\n| WIF Provider | `GCP_WIF_PROVIDER` | `projects/.../providers/github-provider` |\n| WIF Pool | `GCP_WIF_POOL` | `projects/.../workloadIdentityPools/agent-data-pool` |\n| SA Fallback Key | `GCP_SA_KEY_JSON` | D\u00f9ng khi WIF l\u1ed7i |\n| OpenAI Key | `OPENAI_API_KEY` | Secret cho runtime |\n| Lark App Secret | `LARK_APP_SECRET` | Secret cho runtime |\n| Qdrant Mgmt Key | `QDRANT_CLOUD_MGMT_KEY` | Key qu\u1ea3n l\u00fd Qdrant Cloud |\n| Qdrant Cluster Key | `QDRANT_CLUSTER1_KEY` | Key truy c\u1eadp cluster |\n| Qdrant Cluster ID | `QDRANT_CLUSTER1_ID` | ID c\u1ee7a cluster |\n\n- **Ch\u00ednh s\u00e1ch Lu\u00e2n chuy\u1ec3n:** C\u00e1c secret quan tr\u1ecdng (v\u00ed d\u1ee5: `QDRANT_CLUSTER1_KEY`, `OPENAI_API_KEY`) ph\u1ea3i \u0111\u01b0\u1ee3c lu\u00e2n chuy\u1ec3n \u0111\u1ecbnh k\u1ef3: 90 ng\u00e0y cho m\u00f4i tr\u01b0\u1eddng production v\u00e0 120 ng\u00e0y cho m\u00f4i tr\u01b0\u1eddng test.\n  - C\u1ea3nh b\u00e1o Lu\u00e2n chuy\u1ec3n: M\u1ed9t workflow gi\u00e1m s\u00e1t (`secrets-audit.yml`) B\u1eaeT BU\u1ed8C ph\u1ea3i \u0111\u01b0\u1ee3c thi\u1ebft l\u1eadp \u0111\u1ec3 ch\u1ea1y h\u00e0ng ng\u00e0y. Workflow n\u00e0y ph\u1ea3i c\u00f3 kh\u1ea3 n\u0103ng g\u1eedi c\u1ea3nh b\u00e1o qua Slack khi m\u1ed9t secret quan tr\u1ecdng c\u00f2n d\u01b0\u1edbi 15 ng\u00e0y l\u00e0 \u0111\u1ebfn h\u1ea1n lu\u00e2n chuy\u1ec3n.\n\n### 7. Qu\u1ea3n l\u00fd Truy c\u1eadp (IAM)\n- C\u00e1c quy\u1ec1n \u0111\u01b0\u1ee3c ph\u00e9p c\u1ea5p cho Service Account (`chatgpt-deployer@...`):\n  - `roles/artifactregistry.writer`\n  - `roles/cloudfunctions.developer`\n  - `roles/run.admin`\n  - `roles/secretmanager.secretAccessor`\n  - `roles/storage.admin`\n  - `roles/iam.serviceAccountUser`\n  - `roles/viewer`\n  - `roles/logging.logWriter`\n  - `roles/serviceusage.serviceUsageAdmin`\n- C\u00e1c quy\u1ec1n b\u1ecb c\u1ea5m tuy\u1ec7t \u0111\u1ed1i:\n  - `roles/secretmanager.admin`\n  - `roles/iam.serviceAccountAdmin`\n  - `roles/cloudscheduler.admin`\n  - `roles/pubsub.publisher`\n\n### 8. Quy t\u1eafc V\u1eadn h\u00e0nh & T\u1ef1 s\u1eeda l\u1ed7i\nT\u1ea5t c\u1ea3 quy t\u1eafc li\u00ean quan \u0111\u1ebfn:\n- Gi\u1edbi h\u1ea1n retry khi CI th\u1ea5t b\u1ea1i\n- Quy t\u1eafc commit message `[AUTOFIX-x]` k\u00e8m m\u00f4 t\u1ea3 root-cause\n- Ki\u1ec3m so\u00e1t s\u1ed1 l\u01b0\u1ee3ng test (Manifest Drift) v\u00e0 quy tr\u00ecnh c\u1eadp nh\u1eadt `test_manifest_baseline.txt`\n- Th\u1eddi gian ch\u1edd t\u1ed1i thi\u1ec3u gi\u1eefa c\u00e1c l\u1ea7n retry\n- Y\u00eau c\u1ea7u x\u00e1c minh CI tr\u01b0\u1edbc khi b\u00e1o c\u00e1o DONE\n\n```bash\nsleep 10\n```\n\n- Vi\u1ec7c b\u1eaft bu\u1ed9c ch\u1ea1y `verify_setup.sh` (n\u1ebfu t\u1ed3n t\u1ea1i trong repo)\n\n```bash\ncommand -v verify_setup.sh\n```\n\n- Quy tr\u00ecnh C\u1eadp nh\u1eadt Baseline H\u1ee3p l\u1ec7: Khi c\u1ea7n thay \u0111\u1ed5i (th\u00eam/b\u1edbt) file test, Pull Request B\u1eaeT BU\u1ed8C ph\u1ea3i c\u00f3 m\u1ed9t commit ri\u00eang bi\u1ec7t v\u1edbi commit message b\u1eaft \u0111\u1ea7u b\u1eb1ng `[baseline-update]`. Commit n\u00e0y ch\u1ec9 \u0111\u01b0\u1ee3c ch\u1ee9a thay \u0111\u1ed5i c\u1ee7a c\u00e1c file test v\u00e0 file `test_manifest_baseline.txt`. Workflow pass-gate s\u1ebd ki\u1ec3m tra v\u00e0 th\u1ea5t b\u1ea1i n\u1ebfu s\u1ed1 l\u01b0\u1ee3ng test thay \u0111\u1ed5i m\u00e0 kh\u00f4ng c\u00f3 commit tu\u00e2n th\u1ee7 quy tr\u00ecnh n\u00e0y.\n\n```bash\npwd\n```\n\n\u2192 \u0110\u01b0\u1ee3c \u00e1p d\u1ee5ng nguy\u00ean v\u0103n t\u1eeb t\u00e0i li\u1ec7u \"BNEW GLOBAL RULES CURSOR 1.2\", m\u1ee5c 2.1 v\u00e0 \u00a78.\nProject Rules kh\u00f4ng l\u1eb7p l\u1ea1i chi ti\u1ebft \u0111\u1ec3 tr\u00e1nh sai l\u1ec7ch. M\u1ecdi thay \u0111\u1ed5i \u0111\u1ed1i v\u1edbi c\u00e1c quy t\u1eafc n\u00e0y ph\u1ea3i \u0111\u01b0\u1ee3c c\u1eadp nh\u1eadt t\u1ea1i Global Rules, sau \u0111\u00f3 Project Rules s\u1ebd m\u1eb7c \u0111\u1ecbnh k\u1ebf th\u1eeba.\n\n### 9. Quy t\u1eafc B\u1ea3o v\u1ec7 RULES\n- B\u1ea1n tuy\u1ec7t \u0111\u1ed1i kh\u00f4ng \u0111\u01b0\u1ee3c x\u00f3a b\u1ea5t k\u1ef3 n\u1ed9i dung n\u00e0o trong file RULES n\u00e0y n\u1ebfu kh\u00f4ng \u0111\u01b0\u1ee3c y\u00eau c\u1ea7u r\u00f5 r\u00e0ng.",
  "sha256_fmt_norm_A": "c02672af4c7cbfc059e4e12b0e8f8cdc267d547fac135956f8ac55259a4de773",
  "sha256_fmt_norm_B": "bd4267ad8e1ab83facf949fccbcd1eda9c36530bbf7db853329de09d06c90db6",
  "sha256_src_norm_A": "c02672af4c7cbfc059e4e12b0e8f8cdc267d547fac135956f8ac55259a4de773",
  "sha256_src_norm_B": "bd4267ad8e1ab83facf949fccbcd1eda9c36530bbf7db853329de09d06c90db6",
  "source_content": "# \ud83d\udcdc File Quy t\u1eafc D\u1ef1 \u00e1n: RULES_agent-data-langroid.md (Version 1.2)\nC\u1eadp nh\u1eadt: August 07, 2025 (Phi\u00ean b\u1ea3n tu\u00e2n th\u1ee7 Hi\u1ebfn ph\u00e1p v1.11e v\u00e0 c\u00e1c Lu\u1eadt li\u00ean quan)\n\u26d4 QUY T\u1eaeC CURSOR \u2013 D\u1ef0 \u00c1N AGENT DATA LANGROID (B\u1ea3n Ho\u00e0n Ch\u1ec9nh)\nT\u00e0i li\u1ec7u n\u00e0y l\u00e0 ngu\u1ed3n ch\u00e2n l\u00fd duy nh\u1ea5t cho m\u1ecdi ho\u1ea1t \u0111\u1ed9ng c\u1ee7a b\u1ea1n. M\u1ecdi h\u00e0nh \u0111\u1ed9ng ph\u1ea3i tu\u00e2n th\u1ee7 nghi\u00eam ng\u1eb7t c\u00e1c quy t\u1eafc d\u01b0\u1edbi \u0111\u00e2y.\n\n### 1. B\u1ed1i c\u1ea3nh & Ph\u1ea1m vi V\u1eadn h\u00e0nh\nB\u1ea1n ch\u1ec9 l\u00e0m vi\u1ec7c trong c\u00e1c b\u1ed1i c\u1ea3nh \u0111\u00e3 \u0111\u01b0\u1ee3c \u0111\u1ecbnh ngh\u0129a d\u01b0\u1edbi \u0111\u00e2y.\n- \u0110\u01b0\u1eddng d\u1eabn D\u1ef1 \u00e1n Duy nh\u1ea5t:\n  - `/Users/nmhuyen/Documents/Manual Deploy/agent-data-langroid` \n- Project Google Cloud Duy nh\u1ea5t:\n  - `github-chatgpt-ggcloud` \n- Service Account Duy nh\u1ea5t:\n  - `chatgpt-deployer@github-chatgpt-ggcloud.iam.gserviceaccount.com` \n- C\u00e1c Repository trong Ph\u1ea1m vi:\n  - `agent-data-test` (Repo ph\u00e1t tri\u1ec3n & ki\u1ec3m th\u1eed) \n  - `agent-data-production` (Repo s\u1ea3n ph\u1ea9m) \n  - `chatgpt-githubnew` (Repo trung t\u00e2m qu\u1ea3n l\u00fd secrets) \n- Ki\u1ec3m tra nhanh WIF: Tr\u01b0\u1edbc khi \u0111\u1ea9y c\u00e1c thay \u0111\u1ed5i li\u00ean quan \u0111\u1ebfn quy\u1ec1n h\u1ea1n, b\u1ea1n n\u00ean ch\u1ea1y l\u1ec7nh sau tr\u00ean m\u00e1y c\u1ee5c b\u1ed9 \u0111\u1ec3 m\u00f4 ph\u1ecfng v\u00e0 ki\u1ec3m tra c\u00e1c \u0111i\u1ec1u ki\u1ec7n WIF: \n\n```bash\ngcloud auth application-default login --impersonate-service-account=$GCP_SERVICE_ACCOUNT\n```\n\n### 2. Quy t\u1eafc Qu\u1ea3n l\u00fd H\u1ea1 t\u1ea7ng (Terraform)\n\n#### 2.1 Quy \u01b0\u1edbc \u0111\u1eb7t t\u00ean Bucket\n- M\u1ecdi bucket do Terraform qu\u1ea3n l\u00fd ho\u1eb7c kh\u1edfi t\u1ea1o m\u1edbi B\u1eaeT BU\u1ed8C tu\u00e2n th\u1ee7 \u0111\u1ecbnh d\u1ea1ng:\n`<standard-prefix>-agent-data-<purpose>-<env>`\n- `standard-prefix`: c\u1ed1 \u0111\u1ecbnh l\u00e0 `huyen1974`.\n- K\u00fd t\u1ef1: b\u1eaft bu\u1ed9c d\u00f9ng d\u1ea5u g\u1ea1ch ngang (-), c\u1ea5m tuy\u1ec7t \u0111\u1ed1i d\u1ea5u g\u1ea1ch d\u01b0\u1edbi (_).\n- `purpose`: m\u00f4 t\u1ea3 m\u1ee5c \u0111\u00edch bucket (v\u00ed d\u1ee5: `tfstate`, `artifacts`, `backup`).\n- `env`: m\u00f4i tr\u01b0\u1eddng \u00e1p d\u1ee5ng (`dev`, `test`, `prod`).\n\n#### 2.2 Danh s\u00e1ch bucket c\u1ee5 th\u1ec3\n\n| T\u00ean Bucket | M\u1ee5c \u0111\u00edch (`<purpose>`) | M\u00f4i tr\u01b0\u1eddng (`<env>`) |\n| :-- | :-- | :-- |\n| `huyen1974-agent-data-artifacts-test` | `artifacts` | `test` |\n| `huyen1974-agent-data-artifacts-production` | `artifacts` | `production` |\n| `huyen1974-agent-data-knowledge-test` | `knowledge` | `test` |\n| `huyen1974-agent-data-knowledge-production` | `knowledge` | `production` |\n| `huyen1974-agent-data-logs-test` | `logs` | `test` |\n| `huyen1974-agent-data-logs-production` | `logs` | `production` |\n| `huyen1974-agent-data-qdrant-snapshots-test` | `qdrant-snapshots` | `test` |\n| `huyen1974-agent-data-qdrant-snapshots-production` | `qdrant-snapshots` | `production` |\n| `huyen1974-agent-data-source-test` | `source` | `test` |\n| `huyen1974-agent-data-source-production` | `source` | `production` |\n| `huyen1974-agent-data-tfstate-test` | `tfstate` | `test` |\n| `huyen1974-agent-data-tfstate-production` | `tfstate` | `production` |\n| `huyen1974-agent-data-backup-test` | `backup` | `test` |\n| `huyen1974-agent-data-backup-production` | `backup` | `production` |\n\n#### 2.3 Quy \u0111\u1ecbnh v\u1ec1 b\u1ea3o m\u1eadt & truy c\u1eadp\n- Uniform Bucket-Level Access (UBLA): t\u1ea5t c\u1ea3 bucket m\u1edbi B\u1eaeT BU\u1ed8C b\u1eadt UBLA \u0111\u1ec3 tu\u00e2n th\u1ee7 Hi\u1ebfn ph\u00e1p (HP-02) v\u00e0 TF-LAW (\u00a74.3).\n- Legacy bucket: c\u00e1c bucket \u0111\u01b0\u1ee3c t\u1ea1o tr\u01b0\u1edbc khi Hi\u1ebfn ph\u00e1p c\u00f3 hi\u1ec7u l\u1ef1c nh\u01b0ng ch\u01b0a b\u1eadt UBLA \u0111\u01b0\u1ee3c x\u1ebfp lo\u1ea1i \"legacy\" v\u00e0 s\u1ebd \u0111\u01b0\u1ee3c x\u1eed l\u00fd theo n\u1ee3 k\u1ef9 thu\u1eadt TD-TF-01.\n\n#### 2.4 L\u01b0u \u00fd v\u1ec1 c\u1eadp nh\u1eadt & b\u1ea3o tr\u00ec\n- Khi b\u1ed5 sung ho\u1eb7c thay \u0111\u1ed5i bucket, b\u1eaft bu\u1ed9c c\u1eadp nh\u1eadt b\u1ea3ng danh s\u00e1ch \u1edf m\u1ee5c 2.2 \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o Terraform state v\u00e0 t\u00e0i li\u1ec7u lu\u00f4n \u0111\u1ed3ng b\u1ed9.\n- M\u1ecdi thay \u0111\u1ed5i li\u00ean quan \u0111\u1ebfn bucket ph\u1ea3i \u0111\u01b0\u1ee3c commit k\u00e8m l\u00fd do v\u00e0 li\u00ean k\u1ebft t\u1edbi issue ho\u1eb7c ticket k\u1ef9 thu\u1eadt li\u00ean quan.\n\n### 3. Qu\u1ea3n l\u00fd Artifacts & Docker Images\n- N\u01a1i l\u01b0u tr\u1eef: M\u1ecdi Docker images, Cloud Functions v\u00e0 c\u00e1c artifact kh\u00e1c ph\u1ea3i \u0111\u01b0\u1ee3c l\u01b0u tr\u1eef tr\u00ean Google Artifact Registry.\n- Ph\u00e2n t\u00e1ch m\u00f4i tr\u01b0\u1eddng: S\u1ebd c\u00f3 c\u00e1c repository ri\u00eang bi\u1ec7t trong Artifact Registry cho m\u1ed7i m\u00f4i tr\u01b0\u1eddng: `agent-data-test` v\u00e0 `agent-data-production` .\n- Ch\u00ednh s\u00e1ch L\u01b0u gi\u1eef (Retention): Vi\u1ec7c l\u01b0u gi\u1eef artifact B\u1eaeT BU\u1ed8C ph\u1ea3i tu\u00e2n th\u1ee7 quy tr\u00ecnh 2 giai \u0111o\u1ea1n:\n  - 14 ng\u00e0y: C\u00e1c artifact s\u1ebd \u0111\u01b0\u1ee3c t\u1ef1 \u0111\u1ed9ng \u0111\u00e1nh d\u1ea5u l\u00e0 \"stale\" (c\u0169) \u0111\u1ec3 c\u1ea3nh b\u00e1o s\u1edbm.\n  - 30 ng\u00e0y: M\u1ed9t quy tr\u00ecnh t\u1ef1 \u0111\u1ed9ng s\u1ebd t\u1ea1o GitHub Issue [CLEANUP] \u0111\u1ec3 y\u00eau c\u1ea7u ph\u00ea duy\u1ec7t d\u1ecdn d\u1eb9p. Vi\u1ec7c x\u00f3a b\u1ecf ch\u1ec9 \u0111\u01b0\u1ee3c th\u1ef1c hi\u1ec7n th\u1ee7 c\u00f4ng sau khi Issue \u0111\u01b0\u1ee3c \u0111\u00f3ng l\u1ea1i.\n  - B\u00e1o c\u00e1o v\u00e0 C\u1ea3nh b\u00e1o: M\u1ed9t b\u00e1o c\u00e1o t\u1ef1 \u0111\u1ed9ng h\u00e0ng tu\u1ea7n qua Slack s\u1ebd t\u1ed5ng h\u1ee3p s\u1ed1 l\u01b0\u1ee3ng artifact \u0111ang \u0111\u01b0\u1ee3c \u0111\u00e1nh d\u1ea5u \"stale\". B\u00e1o c\u00e1o n\u00e0y B\u1eaeT BU\u1ed8C ph\u1ea3i \u0111\u01b0\u1ee3c c\u1ea5u h\u00ecnh v\u1edbi m\u1ed9t ng\u01b0\u1ee1ng c\u1ea3nh b\u00e1o (v\u00ed d\u1ee5: stale_count < 5) v\u00e0 s\u1ebd g\u1eedi m\u1ed9t c\u1ea3nh b\u00e1o \u0111\u1eb7c bi\u1ec7t n\u1ebfu s\u1ed1 l\u01b0\u1ee3ng v\u01b0\u1ee3t ng\u01b0\u1ee1ng n\u00e0y. \n\n### 4. Qu\u1ea3n l\u00fd D\u1eef li\u1ec7u (Firestore & Metadata)\n\n#### 4.1. Quy t\u1eafc Qu\u1ea3n l\u00fd Qdrant\n- T\u00ean Cluster: Cluster b\u1ea1n l\u00e0m vi\u1ec7c c\u00f3 t\u00ean l\u00e0 `agent-data-vector-dev-useast4`.\n- T\u00ean Collection: T\u00ean collection B\u1eaeT BU\u1ed8C ph\u1ea3i theo \u0111\u1ecbnh d\u1ea1ng `<env>_documents` (v\u00ed d\u1ee5: `test_documents`, `production_documents`).\n- V\u1eadn Qu\u1ea3n l\u00fd Tr\u1ea1ng th\u00e1i Cluster: M\u1ecdi t\u00e1c v\u1ee5 v\u1eadn h\u00e0nh (v\u00ed d\u1ee5: t\u1ea1m d\u1eebng cluster \u0111\u1ec3 ti\u1ebft ki\u1ec7m chi ph\u00ed) B\u1eaeT BU\u1ed8C ph\u1ea3i \u0111\u01b0\u1ee3c th\u1ef1c hi\u1ec7n th\u00f4ng qua Cloud Function `manage_qdrant`. C\u1ee5 th\u1ec3, khi c\u1ea7n t\u1ea1m d\u1eebng cluster, b\u1ea1n ph\u1ea3i g\u1ecdi \u0111\u1ebfn action `stop`, v\u00ec action n\u00e0y \u0111\u00e3 bao g\u1ed3m b\u01b0\u1edbc t\u1ea1o snapshot an to\u00e0n theo y\u00eau_c\u1ea7u c\u1ee7a QD-LAW \u00a74.2.\n- Vai tr\u00f2 c\u1ee7a Firestore: Firestore \u0111\u01b0\u1ee3c s\u1eed d\u1ee5ng cho hai m\u1ee5c \u0111\u00edch ch\u00ednh:\n1.\tL\u01b0u tr\u1eef \nSession Memory cho Agent.\n2.\tL\u01b0u tr\u1eef \nMetadata cho c\u00e1c vector trong Qdrant.\n- Nguy\u00ean t\u1eafc \u0110\u1ed3ng b\u1ed9 B\u1ea5t bi\u1ebfn: M\u1ecdi thao t\u00e1c ghi ho\u1eb7c c\u1eadp nh\u1eadt vector v\u00e0o Qdrant B\u1eaeT BU\u1ed8C ph\u1ea3i \u0111\u01b0\u1ee3c th\u1ef1c hi\u1ec7n song song v\u1edbi vi\u1ec7c ghi ho\u1eb7c c\u1eadp nh\u1eadt metadata t\u01b0\u01a1ng \u1ee9ng v\u00e0o Firestore .\n- Trong tr\u01b0\u1eddng-h\u1ee3p quy tr\u00ecnh \u0111\u1ed3ng b\u1ed9 n\u00e0y g\u1eb7p l\u1ed7i, h\u1ec7 th\u1ed1ng ph\u1ea3i c\u00f3 c\u01a1 ch\u1ebf g\u1eedi c\u1ea3nh b\u00e1o ngay l\u1eadp t\u1ee9c cho Owner (v\u00ed d\u1ee5: qua Slack) \u0111\u1ec3 x\u1eed l\u00fd th\u1ee7 c\u00f4ng.\n- C\u1ea5u tr\u00fac Metadata: C\u1ea5u tr\u00fac chi ti\u1ebft c\u1ee7a metadata v\u00e0 c\u00e1c nh\u00e3n s\u1ebd \u0111\u01b0\u1ee3c \u0111\u1ecbnh ngh\u0129a trong c\u00e1c t\u00e0i li\u1ec7u thi\u1ebft k\u1ebf chuy\u00ean s\u00e2u. Nhi\u1ec7m v\u1ee5 c\u1ee7a b\u1ea1n l\u00e0 tu\u00e2n th\u1ee7 c\u00e1c c\u1ea5u tr\u00fac \u0111\u00e3 \u0111\u01b0\u1ee3c \u0111\u1ecbnh ngh\u0129a trong m\u00e3 ngu\u1ed3n (v\u00ed d\u1ee5: Pydantic models).\n- Ch\u00ednh s\u00e1ch Skip H\u1ee3p l\u1ec7: Trong tr\u01b0\u1eddng h\u1ee3p cluster Qdrant \u0111\u01b0\u1ee3c t\u1ea1m d\u1eebng (tr\u1ea1ng th\u00e1i SUSPENDED), c\u00e1c job CI/CD ph\u1ee5 thu\u1ed9c v\u00e0o Qdrant \u0111\u01b0\u1ee3c ph\u00e9p b\u1ecf qua (skip). Ngo\u1ea1i l\u1ec7 n\u00e0y ch\u1ec9 h\u1ee3p l\u1ec7 n\u1ebfu Pull Request KH\u00d4NG ch\u1ee9a thay \u0111\u1ed5i trong c\u00e1c \u0111\u01b0\u1eddng d\u1eabn file \"li\u00ean quan \u0111\u1ebfn Qdrant\" (tham chi\u1ebfu GLOBAL RULES \u2013 m\u1ee5c 2.3). Tr\u01b0\u1edbc khi th\u1ef1c thi c\u00e1c t\u00e1c v\u1ee5 y\u00eau c\u1ea7u Qdrant, Owner ph\u1ea3i c\u00f3 tr\u00e1ch nhi\u1ec7m k\u00edch ho\u1ea1t l\u1ea1i cluster.\n\n### 5. Quy t\u1eafc CI/CD & GitHub\n\n#### 5.1 Ki\u1ec3m so\u00e1t Lockfile\n- Lockfile (`requirements.txt`) B\u1eaeT BU\u1ed8C \u0111\u01b0\u1ee3c t\u1ea1o b\u1eb1ng:\n\n```bash\npip-compile --no-upgrade\n```\n\n- CI s\u1ebd ki\u1ec3m tra b\u1eb1ng:\n\n```bash\ngit diff --exit-code requirements.txt\n```\n\n\u0111\u1ec3 \u0111\u1ea3m b\u1ea3o file kh\u00f4ng b\u1ecb ch\u1ec9nh s\u1eeda th\u1ee7 c\u00f4ng.\n\n#### 5.2 Pre-commit Hooks\n- M\u1ecdi commit B\u1eaeT BU\u1ed8C ph\u1ea3i v\u01b0\u1ee3t qua c\u00e1c hook \u0111\u00e3 \u0111\u01b0\u1ee3c \u0111\u1ecbnh ngh\u0129a trong `.pre-commit-config.yaml`, bao g\u1ed3m:\n  - `black`, `ruff`, `trufflehog`, `manifest-drift`.\n\n#### 5.3 Quy \u0111\u1ecbnh v\u1ec1 Workflow T\u1ed5ng h\u1ee3p (Pass Gate)\n- Repository ch\u1ec9 \u0111\u01b0\u1ee3c ph\u00e9p c\u00f3 duy nh\u1ea5t m\u1ed9t workflow \u0111\u01b0\u1ee3c trigger tr\u1ef1c ti\u1ebfp l\u00e0: `.github/workflows/pass-gate.yml`\n- C\u00e1c workflow kh\u00e1c (`lint-only.yml`, `terraform-plan.yml`, `secret-scan.yml`, `manifest-drift.yml`, `agent-e2e.yml`) B\u1eaeT BU\u1ed8C ph\u1ea3i \u0111\u01b0\u1ee3c c\u1ea5u h\u00ecnh v\u1edbi `on: workflow_call` v\u00e0 ch\u1ec9 \u0111\u01b0\u1ee3c k\u00edch ho\u1ea1t b\u1edfi `pass-gate.yml`.\n- C\u00e1c workflow \u0111\u01b0\u1ee3c g\u1ecdi qua `on: workflow_call` C\u1ea4M TUY\u1ec6T \u0110\u1ed0I s\u1eed d\u1ee5ng `secrets: inherit`. Workflow `pass-gate.yml` ch\u1ec9 \u0111\u01b0\u1ee3c ph\u00e9p truy\u1ec1n c\u00e1c gi\u00e1 tr\u1ecb \u0111\u1ea7u v\u00e0o (`inputs`) ho\u1eb7c bi\u1ebfn m\u00f4i tr\u01b0\u1eddng (`env`) t\u1ed1i thi\u1ec3u c\u1ea7n thi\u1ebft, v\u00e0 kh\u00f4ng \u0111\u01b0\u1ee3c truy\u1ec1n secrets cho c\u00e1c job \u0111\u01b0\u1ee3c k\u00edch ho\u1ea1t b\u1edfi PR t\u1eeb fork.\n\n#### 5.4 Branch Protection & Status Check\n- Ch\u1ec9 thi\u1ebft l\u1eadp duy nh\u1ea5t 1 status check Required: Pass Gate\n- Kh\u00f4ng \u0111\u1ec3 nhi\u1ec1u check ri\u00eang l\u1ebb nh\u1eb1m tr\u00e1nh \u0111\u00e1nh gi\u00e1 sai tr\u1ea1ng th\u00e1i t\u1ed5ng th\u1ec3.\n- Ghi ch\u00fa: T\u00ean status check \"Pass Gate\" l\u00e0 c\u1ed1 \u0111\u1ecbnh. M\u1ecdi thay \u0111\u1ed5i \u0111\u1ed1i v\u1edbi t\u00ean job ho\u1eb7c context trong workflow `pass-gate.yml` B\u1eaeT BU\u1ed8C ph\u1ea3i \u0111\u01b0\u1ee3c c\u1eadp nh\u1eadt \u0111\u1ed3ng b\u1ed9 trong c\u00e0i \u0111\u1eb7t Branch Protection \u0111\u1ec3 tr\u00e1nh t\u00ecnh tr\u1ea1ng merge b\u1ecb ch\u1eb7n ho\u1eb7c \"xanh gi\u1ea3\".\n\n#### 5.5 Chi ti\u1ebft Job Gate v\u00e0 X\u1eed l\u00fd ng\u1eef c\u1ea3nh\n- Job t\u1ed5ng h\u1ee3p trong `pass-gate.yml` PH\u1ea2I ch\u1ea1y v\u1edbi \u0111i\u1ec1u ki\u1ec7n: `if: ${{ always() }}`.\n- Kh\u00e1i ni\u1ec7m `REQUIRED_JOBS`: M\u1ed9t danh s\u00e1ch c\u00e1c job con b\u1eaft bu\u1ed9c ph\u1ea3i th\u00e0nh c\u00f4ng \u0111\u01b0\u1ee3c x\u00e1c \u0111\u1ecbnh d\u1ef1a tr\u00ean ng\u1eef c\u1ea3nh c\u1ee7a Pull Request:\n  - PR t\u1eeb nh\u00e1nh n\u1ed9i b\u1ed9: Y\u00eau c\u1ea7u t\u1ea5t c\u1ea3 c\u00e1c job ch\u00ednh (`lint`, `secret-scan`, `manifest-drift`, `terraform-plan`, `agent-e2e`).\n  - PR t\u1eeb fork: Kh\u00f4ng y\u00eau c\u1ea7u c\u00e1c job c\u1ea7n secrets/WIF (`terraform-plan`, `agent-e2e`).\n- Job gate PH\u1ea2I FAIL n\u1ebfu b\u1ea5t k\u1ef3 job n\u00e0o trong danh s\u00e1ch `REQUIRED_JOBS` c\u00f3 conclusion kh\u00e1c `success`. C\u00e1c job `skipped` kh\u00f4ng thu\u1ed9c `REQUIRED_JOBS` (v\u00ed d\u1ee5: do PR t\u1eeb fork) s\u1ebd \u0111\u01b0\u1ee3c b\u1ecf qua.\n- Ghi ch\u00fa tri\u1ec3n khai: Vi\u1ec7c x\u00e1c \u0111\u1ecbnh PR t\u1eeb fork trong workflow c\u00f3 th\u1ec3 \u0111\u01b0\u1ee3c th\u1ef1c hi\u1ec7n b\u1eb1ng \u0111i\u1ec1u ki\u1ec7n sau: `if: ${{ github.event.pull_request.head.repo.fork == true }}`. D\u1ef1a v\u00e0o \u0111i\u1ec1u ki\u1ec7n n\u00e0y, danh s\u00e1ch `REQUIRED_JOBS` s\u1ebd \u0111\u01b0\u1ee3c \u0111i\u1ec1u ch\u1ec9nh \u0111\u1ec3 lo\u1ea1i b\u1ecf c\u00e1c job c\u1ea7n secrets/WIF.\n\n#### 5.6 C\u1ea5u h\u00ecnh Concurrency v\u00e0 Quy t\u1eafc X\u00e1c minh\n- File `pass-gate.yml` B\u1eaeT BU\u1ed8C ph\u1ea3i c\u00f3 \u0111o\u1ea1n sau \u0111\u1ec3 h\u1ee7y c\u00e1c l\u1ea7n ch\u1ea1y CI c\u0169 khi c\u00f3 commit m\u1edbi, tr\u00e1nh l\u00e3ng ph\u00ed t\u00e0i nguy\u00ean v\u00e0 t\u00ecnh tr\u1ea1ng \u0111ua tr\u1ea1ng th\u00e1i:\n\n```yaml\nconcurrency:\n  group: pass-gate-${{ github.ref }}\n  cancel-in-progress: true\n```\n\n- Ghi ch\u00fa Quan tr\u1ecdng: Do c\u00f3 thi\u1ebft l\u1eadp `cancel-in-progress: true`, c\u00f3 th\u1ec3 c\u00f3 nhi\u1ec1u CI run \u0111\u01b0\u1ee3c t\u1ea1o ra r\u1ed3i b\u1ecb h\u1ee7y cho c\u00f9ng m\u1ed9t commit. V\u00ec v\u1eady, b\u1ea1n B\u1eaeT BU\u1ed8C ph\u1ea3i tu\u00e2n th\u1ee7 nguy\u00ean v\u0103n quy tr\u00ecnh Post-push CI Verification (GLOBAL RULES \u2013 m\u1ee5c 2.1): t\u00ecm \u0111\u00fang `RUN_ID` c\u1ee7a commit SHA cu\u1ed1i c\u00f9ng v\u00e0 ch\u1ec9 theo d\u00f5i run \u0111\u00f3 \u0111\u1ec3 tr\u00e1nh \u0111\u1ecdc nh\u1ea7m k\u1ebft qu\u1ea3 t\u1eeb m\u1ed9t run \u0111\u00e3 b\u1ecb h\u1ee7y.\n\n#### 5.7 Terraform Init Chu\u1ea9n\n- Trong job plan:\n\n```bash\nterraform init -reconfigure -backend-config=terraform/backend.hcl\n```\n\n- Trong job lint-only:\n\n```bash\nterraform init -backend=false && terraform validate -no-color\n```\n\n- C\u1ea5m m\u1ecdi backend auto \u0111\u1ec3 tr\u00e1nh l\u1ed7i \"bucket not set\".\n\n#### 5.8 Quy t\u1eafc v\u1ec1 Shell an to\u00e0n & continue-on-error\n- Tu\u00e2n th\u1ee7 nguy\u00ean v\u0103n GLOBAL RULES \u2013 m\u1ee5c 2.2. C\u1ea5m tuy\u1ec7t \u0111\u1ed1i `continue-on-error` (ngo\u1ea1i tr\u1eeb b\u01b0\u1edbc \"auth fallback\" n\u1ebfu c\u00f3), b\u1eaft bu\u1ed9c s\u1eed d\u1ee5ng `shell: bash -euo pipefail {0}` cho t\u1ea5t c\u1ea3 c\u00e1c b\u01b0\u1edbc `run:`.\n\n##### 5.8.1 Policy Guard cho Trigger v\u00e0 C\u1ea5u h\u00ecnh Job\nWorkflow `pass-gate.yml` B\u1eaeT BU\u1ed8C ph\u1ea3i c\u00f3 m\u1ed9t job `workflow-policy-guard` ch\u1ea1y \u0111\u1ea7u ti\u00ean. Job n\u00e0y c\u00f3 c\u00e1c tr\u00e1ch nhi\u1ec7m sau:\n- S\u1eed d\u1ee5ng c\u00e1c c\u00f4ng c\u1ee5 nh\u01b0 `actionlint` ho\u1eb7c `grep` \u0111\u1ec3 ki\u1ec3m tra v\u00e0 l\u00e0m th\u1ea5t b\u1ea1i (fail) workflow n\u1ebfu ph\u00e1t hi\u1ec7n b\u1ea5t k\u1ef3 file workflow n\u00e0o kh\u00e1c (ngo\u00e0i `pass-gate.yml`) c\u00f3 ch\u1ee9a trigger `on: push` ho\u1eb7c `on: pull_request`.\n- Ki\u1ec3m tra v\u00e0 l\u00e0m th\u1ea5t b\u1ea1i workflow n\u1ebfu ph\u00e1t hi\u1ec7n b\u1ea5t k\u1ef3 job n\u00e0o trong danh s\u00e1ch `REQUIRED_JOBS` (\u0111\u1ecbnh ngh\u0129a t\u1ea1i m\u1ee5c 5.5) c\u00f3 s\u1eed d\u1ee5ng c\u00e1c \u0111i\u1ec1u ki\u1ec7n `paths:`, `paths-ignore:`, ho\u1eb7c `if:` c\u00f3 kh\u1ea3 n\u0103ng l\u00e0m job \u0111\u00f3 b\u1ecb b\u1ecf qua (skip) m\u1ed9t c\u00e1ch kh\u00f4ng h\u1ee3p l\u1ec7.\n- Ki\u1ec3m tra v\u00e0 l\u00e0m th\u1ea5t b\u1ea1i workflow n\u1ebfu ph\u00e1t hi\u1ec7n b\u1ea5t k\u1ef3 job n\u00e0o trong danh s\u00e1ch `REQUIRED_JOBS` c\u00f3 ch\u1ee9a `continue-on-error: true` (ngo\u1ea1i tr\u1eeb c\u00e1c b\u01b0\u1edbc \"auth fallback\" \u0111\u00e3 \u0111\u01b0\u1ee3c cho ph\u00e9p).\n\n##### 5.8.2 File backend.hcl B\u1eaft bu\u1ed9c\nM\u00e3 ngu\u1ed3n Terraform B\u1eaeT BU\u1ed8C ph\u1ea3i c\u00f3 file `terraform/backend.hcl` \u0111\u01b0\u1ee3c commit v\u00e0o repository. File n\u00e0y \u0111\u1ecbnh ngh\u0129a c\u1ea5u h\u00ecnh backend chu\u1ea9n v\u00e0 l\u00e0 ngu\u1ed3n ch\u00e2n l\u00fd duy nh\u1ea5t cho vi\u1ec7c kh\u1edfi t\u1ea1o Terraform.\n\n##### 5.8.3 Kh\u00f3a c\u1ee9ng Permissions c\u1ee7a Workflow\nM\u1ecdi workflow B\u1eaeT BU\u1ed8C ph\u1ea3i \u0111\u01b0\u1ee3c c\u1ea5u h\u00ecnh v\u1edbi quy\u1ec1n h\u1ea1n \u1edf m\u1ee9c t\u1ed1i thi\u1ec3u:\n\n```yaml\npermissions: { contents: read }\n```\n\nCh\u1ec9 nh\u1eefng job th\u1ef1c s\u1ef1 c\u1ea7n OIDC m\u1edbi \u0111\u01b0\u1ee3c c\u1ea5p th\u00eam `id-token: write`. C\u1ea5m tuy\u1ec7t \u0111\u1ed1i s\u1eed d\u1ee5ng `pull_request_target` trong c\u00e1c repo con.\n\n#### 5.9 Post-push CI Verification (Chu\u1ea9n h\u00f3a Log v\u00e0 Artifact)\nQuy tr\u00ecnh n\u00e0y tu\u00e2n th\u1ee7 nguy\u00ean v\u0103n GLOBAL RULES \u2013 m\u1ee5c 2.1, v\u1edbi c\u00e1c chi ti\u1ebft k\u1ef9 thu\u1eadt \u0111\u01b0\u1ee3c l\u00e0m r\u00f5 nh\u01b0 sau:\n- X\u00e1c \u0111\u1ecbnh L\u1ed7i: Sau m\u1ed7i l\u1ea7n push/PR, CI s\u1ebd ki\u1ec3m tra c\u00e1c run c\u00f3 `headSha` tr\u00f9ng v\u1edbi commit hi\u1ec7n t\u1ea1i. N\u1ebfu c\u00f3 run th\u1ea5t b\u1ea1i (`failure`, `cancelled`, `timed_out`), quy tr\u00ecnh t\u1ef1 s\u1eeda l\u1ed7i s\u1ebd \u0111\u01b0\u1ee3c k\u00edch ho\u1ea1t.\n- L\u01b0u v\u00e0 Tr\u00ecnh b\u00e0y Log:\n  - Khi m\u1ed9t v\u00f2ng s\u1eeda l\u1ed7i b\u1eaft \u0111\u1ea7u, log c\u1ee7a job th\u1ea5t b\u1ea1i B\u1eaeT BU\u1ed8C ph\u1ea3i \u0111\u01b0\u1ee3c l\u01b0u v\u00e0o m\u1ed9t file theo \u0111\u1ecbnh d\u1ea1ng: `.ci/${SHA}.autofix<N>.log` (v\u1edbi N l\u00e0 1 ho\u1eb7c 2).\n  - File log n\u00e0y B\u1eaeT BU\u1ed8C ph\u1ea3i \u0111\u01b0\u1ee3c t\u1ea3i l\u00ean (upload) l\u00e0m artifact c\u1ee7a CI run \u0111\u00f3.\n  - C\u1ea4M TUY\u1ec6T \u0110\u1ed0I commit c\u00e1c file log v\u00e0o repository. Th\u01b0 m\u1ee5c `.ci/` ph\u1ea3i \u0111\u01b0\u1ee3c th\u00eam v\u00e0o file `.gitignore`.\n- Quy tr\u00ecnh T\u1ef1 s\u1eeda l\u1ed7i (Auto-fix):\n  - V\u00f2ng 1: Commit b\u1ea3n s\u1eeda l\u1ed7i v\u1edbi message b\u1eaft \u0111\u1ea7u b\u1eb1ng `[AUTOFIX-1] <root-cause>`.\n  - V\u00f2ng 2: N\u1ebfu v\u1eabn th\u1ea5t b\u1ea1i, l\u1eb7p l\u1ea1i quy tr\u00ecnh v\u1edbi commit message `[AUTOFIX-2] <root-cause>`.\n  - Sau 2 v\u00f2ng n\u1ebfu v\u1eabn th\u1ea5t b\u1ea1i, Cursor ph\u1ea3i d\u1eebng l\u1ea1i v\u00e0 t\u1ea1o issue v\u1edbi ti\u00eau \u0111\u1ec1: \ud83d\uded1 CI still failing after 2 auto-fixes. N\u1ed9i dung issue ph\u1ea3i \u0111\u00ednh k\u00e8m link \u0111\u1ebfn CI run th\u1ea5t b\u1ea1i cu\u1ed1i c\u00f9ng.\n\n#### 5.10 Pass-gate Merge Policy\n- Pull Request ch\u1ec9 \u0111\u01b0\u1ee3c merge khi workflow `pass-gate.yml` XANH HO\u00c0N TO\u00c0N.\n\n#### 5.11 Tag cho Production Release\n- Tag PH\u1ea2I theo \u0111\u1ecbnh d\u1ea1ng:\n\n```text\nvX.Y.Z\n```\n\n(v\u00ed d\u1ee5: `v1.2.3`)\n\n#### 5.12 C\u1ea3nh b\u00e1o N\u1ee3 K\u1ef9 thu\u1eadt (t\u1ea1m th\u1eddi)\n- Cho \u0111\u1ebfn khi dashboard `agent-data-ops` ho\u00e0n thi\u1ec7n (HP-OBS-01), c\u00e1c CI ch\u00ednh PH\u1ea2I in ra:\n\n```bash\n::warning:: Gi\u00e1m s\u00e1t ch\u01b0a ho\u00e0n ch\u1ec9nh \u2013 vui l\u00f2ng theo d\u00f5i th\u1ee7 c\u00f4ng.\n```\n\n#### 5.13 Chu\u1ea9n ho\u00e1 M\u00fai gi\u1edd CI/CD (UTC)\n- M\u1ecdi ki\u1ec3m tra CI/CD, x\u00e1c th\u1ef1c tr\u1ea1ng th\u00e1i pass-gate, ph\u00e2n t\u00edch l\u1ecbch s\u1eed push/pull request B\u1eaeT BU\u1ed8C ph\u1ea3i \u0111\u01b0\u1ee3c th\u1ef1c hi\u1ec7n theo chu\u1ea9n m\u00fai gi\u1edd UTC.\n- Quy \u0111\u1ecbnh n\u00e0y nh\u1eb1m tr\u00e1nh s\u1ef1 sai l\u1ec7ch gi\u1eefa th\u1eddi gian ghi nh\u1eadn c\u1ee7a GitHub Actions runner v\u00e0 c\u00e1c l\u1ec7nh ki\u1ec3m tra b\u1eb1ng CLI nh\u01b0 `gh run view`, `gh run list`.\n- N\u1ed9i dung k\u1ebf th\u1eeba t\u1eeb t\u00e0i li\u1ec7u ch\u00ednh th\u1ee9c: PLAN MERGE TO LAW 1.12 (M\u1ee5c 4.1 v\u00e0 4.2).\n\n### 6. Qu\u1ea3n l\u00fd Secrets (C\u1ef0C K\u1ef2 QUAN TR\u1eccNG)\n- Ngu\u1ed3n Ch\u00e2n l\u00fd: Google Secret Manager l\u00e0 ngu\u1ed3n duy nh\u1ea5t cho gi\u00e1 tr\u1ecb c\u1ee7a secrets.\n- C\u01a1 ch\u1ebf \u0110\u1ed3ng b\u1ed9: Secrets tr\u00ean GitHub \u0111\u01b0\u1ee3c qu\u1ea3n l\u00fd T\u1eacP TRUNG. M\u1ed9t workflow \n`sync-secrets.yml` t\u1ea1i repo `chatgpt-githubnew` l\u00e0 quy tr\u00ecnh DUY NH\u1ea4T \u0111\u01b0\u1ee3c ph\u00e9p ghi (`secrets:write`) secrets l\u00ean c\u00e1c repo `agent-data-test` v\u00e0 `agent-data-production` .\n- Nhi\u1ec7m v\u1ee5 c\u1ee7a Cursor: B\u1ea1n KH\u00d4NG \u0110\u01af\u1ee2C PH\u00c9P t\u1ea1o, s\u1eeda, ho\u1eb7c x\u00f3a secrets tr\u1ef1c ti\u1ebfp tr\u00ean `agent-data-test` ho\u1eb7c `agent-data-production`. Quy tr\u00ecnh X\u1eed l\u00fd S\u1ef1 c\u1ed1 (Fallback): Trong tr\u01b0\u1eddng h\u1ee3p workflow `sync-secrets.yml` g\u1eb7p s\u1ef1 c\u1ed1 k\u00e9o d\u00e0i (>24h), vi\u1ec7c c\u1eadp nh\u1eadt th\u1ee7 c\u00f4ng s\u1ebd \u0111\u01b0\u1ee3c th\u1ef1c hi\u1ec7n theo quy tr\u00ecnh fallback \u0111\u00e3 quy \u0111\u1ecbnh t\u1ea1i GH-LAW \u00a75.5.\n- Danh s\u00e1ch Secrets: D\u01b0\u1edbi \u0111\u00e2y l\u00e0 danh s\u00e1ch c\u00e1c secret b\u1ea1n s\u1ebd l\u00e0m vi\u1ec7c.\n\n| M\u1ee5c \u0111\u00edch | T\u00ean Secret tr\u00ean GitHub | Ghi ch\u00fa |\n| :-- | :-- | :-- |\n| GCP Project ID | `GCP_PROJECT_ID` | Gi\u00e1 tr\u1ecb: `github-chatgpt-ggcloud` |\n| Deployer SA | `GCP_SERVICE_ACCOUNT` | Gi\u00e1 tr\u1ecb: `chatgpt-deployer@...` |\n| WIF Provider | `GCP_WIF_PROVIDER` | `projects/.../providers/github-provider` |\n| WIF Pool | `GCP_WIF_POOL` | `projects/.../workloadIdentityPools/agent-data-pool` |\n| SA Fallback Key | `GCP_SA_KEY_JSON` | D\u00f9ng khi WIF l\u1ed7i |\n| OpenAI Key | `OPENAI_API_KEY` | Secret cho runtime |\n| Lark App Secret | `LARK_APP_SECRET` | Secret cho runtime |\n| Qdrant Mgmt Key | `QDRANT_CLOUD_MGMT_KEY` | Key qu\u1ea3n l\u00fd Qdrant Cloud |\n| Qdrant Cluster Key | `QDRANT_CLUSTER1_KEY` | Key truy c\u1eadp cluster |\n| Qdrant Cluster ID | `QDRANT_CLUSTER1_ID` | ID c\u1ee7a cluster |\n\n- **Ch\u00ednh s\u00e1ch Lu\u00e2n chuy\u1ec3n:** C\u00e1c secret quan tr\u1ecdng (v\u00ed d\u1ee5: `QDRANT_CLUSTER1_KEY`, `OPENAI_API_KEY`) ph\u1ea3i \u0111\u01b0\u1ee3c lu\u00e2n chuy\u1ec3n \u0111\u1ecbnh k\u1ef3: 90 ng\u00e0y cho m\u00f4i tr\u01b0\u1eddng production v\u00e0 120 ng\u00e0y cho m\u00f4i tr\u01b0\u1eddng test.\n  - C\u1ea3nh b\u00e1o Lu\u00e2n chuy\u1ec3n: M\u1ed9t workflow gi\u00e1m s\u00e1t (`secrets-audit.yml`) B\u1eaeT BU\u1ed8C ph\u1ea3i \u0111\u01b0\u1ee3c thi\u1ebft l\u1eadp \u0111\u1ec3 ch\u1ea1y h\u00e0ng ng\u00e0y. Workflow n\u00e0y ph\u1ea3i c\u00f3 kh\u1ea3 n\u0103ng g\u1eedi c\u1ea3nh b\u00e1o qua Slack khi m\u1ed9t secret quan tr\u1ecdng c\u00f2n d\u01b0\u1edbi 15 ng\u00e0y l\u00e0 \u0111\u1ebfn h\u1ea1n lu\u00e2n chuy\u1ec3n.\n\n### 7. Qu\u1ea3n l\u00fd Truy c\u1eadp (IAM)\n- C\u00e1c quy\u1ec1n \u0111\u01b0\u1ee3c ph\u00e9p c\u1ea5p cho Service Account (`chatgpt-deployer@...`):\n  - `roles/artifactregistry.writer`\n  - `roles/cloudfunctions.developer`\n  - `roles/run.admin`\n  - `roles/secretmanager.secretAccessor`\n  - `roles/storage.admin`\n  - `roles/iam.serviceAccountUser`\n  - `roles/viewer`\n  - `roles/logging.logWriter`\n  - `roles/serviceusage.serviceUsageAdmin`\n- C\u00e1c quy\u1ec1n b\u1ecb c\u1ea5m tuy\u1ec7t \u0111\u1ed1i:\n  - `roles/secretmanager.admin`\n  - `roles/iam.serviceAccountAdmin`\n  - `roles/cloudscheduler.admin`\n  - `roles/pubsub.publisher`\n\n### 8. Quy t\u1eafc V\u1eadn h\u00e0nh & T\u1ef1 s\u1eeda l\u1ed7i\nT\u1ea5t c\u1ea3 quy t\u1eafc li\u00ean quan \u0111\u1ebfn:\n- Gi\u1edbi h\u1ea1n retry khi CI th\u1ea5t b\u1ea1i\n- Quy t\u1eafc commit message `[AUTOFIX-x]` k\u00e8m m\u00f4 t\u1ea3 root-cause\n- Ki\u1ec3m so\u00e1t s\u1ed1 l\u01b0\u1ee3ng test (Manifest Drift) v\u00e0 quy tr\u00ecnh c\u1eadp nh\u1eadt `test_manifest_baseline.txt`\n- Th\u1eddi gian ch\u1edd t\u1ed1i thi\u1ec3u gi\u1eefa c\u00e1c l\u1ea7n retry\n- Y\u00eau c\u1ea7u x\u00e1c minh CI tr\u01b0\u1edbc khi b\u00e1o c\u00e1o DONE\n\n```bash\nsleep 10\n```\n\n- Vi\u1ec7c b\u1eaft bu\u1ed9c ch\u1ea1y `verify_setup.sh` (n\u1ebfu t\u1ed3n t\u1ea1i trong repo)\n\n```bash\ncommand -v verify_setup.sh\n```\n\n- Quy tr\u00ecnh C\u1eadp nh\u1eadt Baseline H\u1ee3p l\u1ec7: Khi c\u1ea7n thay \u0111\u1ed5i (th\u00eam/b\u1edbt) file test, Pull Request B\u1eaeT BU\u1ed8C ph\u1ea3i c\u00f3 m\u1ed9t commit ri\u00eang bi\u1ec7t v\u1edbi commit message b\u1eaft \u0111\u1ea7u b\u1eb1ng `[baseline-update]`. Commit n\u00e0y ch\u1ec9 \u0111\u01b0\u1ee3c ch\u1ee9a thay \u0111\u1ed5i c\u1ee7a c\u00e1c file test v\u00e0 file `test_manifest_baseline.txt`. Workflow pass-gate s\u1ebd ki\u1ec3m tra v\u00e0 th\u1ea5t b\u1ea1i n\u1ebfu s\u1ed1 l\u01b0\u1ee3ng test thay \u0111\u1ed5i m\u00e0 kh\u00f4ng c\u00f3 commit tu\u00e2n th\u1ee7 quy tr\u00ecnh n\u00e0y.\n\n```bash\npwd\n```\n\n\u2192 \u0110\u01b0\u1ee3c \u00e1p d\u1ee5ng nguy\u00ean v\u0103n t\u1eeb t\u00e0i li\u1ec7u \"BNEW GLOBAL RULES CURSOR 1.2\", m\u1ee5c 2.1 v\u00e0 \u00a78.\nProject Rules kh\u00f4ng l\u1eb7p l\u1ea1i chi ti\u1ebft \u0111\u1ec3 tr\u00e1nh sai l\u1ec7ch. M\u1ecdi thay \u0111\u1ed5i \u0111\u1ed1i v\u1edbi c\u00e1c quy t\u1eafc n\u00e0y ph\u1ea3i \u0111\u01b0\u1ee3c c\u1eadp nh\u1eadt t\u1ea1i Global Rules, sau \u0111\u00f3 Project Rules s\u1ebd m\u1eb7c \u0111\u1ecbnh k\u1ebf th\u1eeba.\n\n### 9. Quy t\u1eafc B\u1ea3o v\u1ec7 RULES\n- B\u1ea1n tuy\u1ec7t \u0111\u1ed1i kh\u00f4ng \u0111\u01b0\u1ee3c x\u00f3a b\u1ea5t k\u1ef3 n\u1ed9i dung n\u00e0o trong file RULES n\u00e0y n\u1ebfu kh\u00f4ng \u0111\u01b0\u1ee3c y\u00eau c\u1ea7u r\u00f5 r\u00e0ng.\n",
  "structural_checks": {
    "bucket_count_preserved": true,
    "concurrency_present": true,
    "formatted_buckets": 14,
    "formatted_placeholders": 9,
    "formatted_secrets": 7,
    "placeholders_equal": true,
    "retention_14_preserved": true,
    "retention_30_preserved": true,
    "secret_count_preserved": true,
    "source_buckets": 14,
    "source_placeholders": 9,
    "source_secrets": 7,
    "terraform_commands_present": true
  },
  "verifier_A_equal": true,
  "verifier_B_equal": true
}
