**GLOBAL_RULES.md (Version 1.2)**

**üåç QUY T·∫ÆC TO√ÄN C·ª§C (GLOBAL RULES)**

**Version 1.2**

T√†i li·ªáu n√†y ƒë·ªãnh nghƒ©a c√°c nguy√™n t·∫Øc c·ªët l√µi, b·∫•t bi·∫øn m√† b·∫°n ph·∫£i tu√¢n th·ªß trong m·ªçi ho√†n c·∫£nh. C√°c quy t·∫Øc n√†y c√≥ hi·ªáu l·ª±c cao h∆°n v√† b·ªï tr·ª£ cho file quy t·∫Øc d·ª± √°n chi ti·∫øt (RULES_agent-data-langroid.md).

**1. Nguy√™n t·∫Øc Ph·∫°m vi Duy nh·∫•t (Single Scope Principle)**

B·∫°n ch·ªâ l√†m vi·ªác **duy nh·∫•t** trong m·ªôt b·ªëi c·∫£nh ƒë√£ ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a.

- **ƒê∆∞·ªùng d·∫´n D·ª± √°n ƒê·ªôc quy·ªÅn:** /Users/nmhuyen/Documents/Manual Deploy/agent-data-langroid *(Ghi ch√∫: Quy t·∫Øc v·ªÅ ƒë∆∞·ªùng d·∫´n ch√≠nh x√°c n√†y ch·ªâ √°p d·ª•ng cho m√¥i tr∆∞·ªùng ph√°t tri·ªÉn c·ª•c b·ªô, kh√¥ng √°p d·ª•ng cho c√°c runner CI/CD.)*

- **C·∫•m tuy·ªát ƒë·ªëi:** Kh√¥ng ƒë∆∞·ª£c ƒë·ªçc, ghi, hay tham chi·∫øu ƒë·∫øn b·∫•t k·ª≥ d·ª± √°n, repository, ho·∫∑c th∆∞ m·ª•c n√†o kh√°c ngo√†i ph·∫°m vi ƒë√£ ƒë·ªãnh.

- Ghi ch√∫ v·ªÅ s·ª± T∆∞∆°ng quan v·ªõi Project Rules: ƒê·ªÉ ƒë·∫£m b·∫£o t√≠nh to√†n v·∫πn c·ªßa quy tr√¨nh CI/CD, b·∫°n **B·∫ÆT BU·ªòC** ph·∫£i tu√¢n th·ªß ki·∫øn tr√∫c **"M·ªôt c·ª≠a - Pass Gate"** ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a chi ti·∫øt trong RULES_agent-data-langroid.md (M·ª•c 5). Nguy√™n t·∫Øc n√†y quy ƒë·ªãnh ch·ªâ c√≥ duy nh·∫•t m·ªôt status check ƒë∆∞·ª£c ph√©p l√†m c·ªïng ki·ªÉm so√°t (Required check), c√°c job ki·ªÉm tra kh√°c ph·∫£i ƒë∆∞·ª£c g·ªçi qua workflow_call ƒë·ªÉ t·∫°o ra m·ªôt t√≠n hi·ªáu pass/fail t·ªïng th·ªÉ duy nh·∫•t, r√µ r√†ng.

**2. Nguy√™n t·∫Øc X√°c minh B·∫Øt bu·ªôc (Mandatory Verification Principle)**

**2.1 Post-push CI Verification (HARD-BLOCK)**

Sau m·ªói l·∫ßn push ho·∫∑c m·ªü/c·∫≠p nh·∫≠t Pull Request, b·∫°n B·∫ÆT BU·ªòC ph·∫£i th·ª±c thi quy tr√¨nh x√°c minh CI m·ªôt c√°ch nghi√™m ng·∫∑t:

- **B∆∞·ªõc A: L·∫•y RUN_ID c·ªßa run m·ªõi nh·∫•t, kh√¥ng b·ªã h·ªßy, theo commit SHA.**

> B·∫°n ph·∫£i x√°c ƒë·ªãnh RUN_ID c·ªßa workflow ƒë∆∞·ª£c k√≠ch ho·∫°t b·ªüi ch√≠nh commit SHA b·∫°n v·ª´a push. Logic **B·∫ÆT BU·ªòC** ph·∫£i l·ªçc b·ªè c√°c run ƒë√£ b·ªã h·ªßy (conclusion: "cancelled") v√† ch·ªâ ch·ªçn run ƒë√£ ho√†n th√†nh (status: "completed") ƒë∆∞·ª£c t·∫°o g·∫ßn nh·∫•t. C·∫•m watch m·ªôt c√°ch chung chung.

- **L·ªánh tham kh·∫£o:**

> SHA=\$(git rev-parse HEAD)
>
> RUN_ID=\$(gh run list --commit "\$SHA" --json databaseId,conclusion,status,createdAt --jq 'map(select(.status == "completed" and .conclusion != "cancelled")) \| sort_by(.createdAt) \| .\[-1\].databaseId' -q)

- **B∆∞·ªõc B: Theo d√µi v√† ch·ªù k·∫øt qu·∫£.**

1.  S·ª≠ d·ª•ng RUN_ID ƒë√£ x√°c ƒë·ªãnh ƒë·ªÉ theo d√µi cho ƒë·∫øn khi workflow k·∫øt th√∫c.

2.  L·ªánh b·∫Øt bu·ªôc: gh run watch "\$RUN_ID" --exit-status

3.  N·∫øu l·ªánh tr√™n th·∫•t b·∫°i (CI ƒë·ªè), b·∫°n ph·∫£i chuy·ªÉn sang **B∆∞·ªõc C**.

- **B∆∞·ªõc B.1: X·ª≠ l√Ω tr∆∞·ªùng h·ª£p Run b·ªã h·ªßy do Push m·ªõi.** N·∫øu l·ªánh gh run watch ·ªü B∆∞·ªõc B th·∫•t b·∫°i v·ªõi tr·∫°ng th√°i cancelled, ƒë√¢y kh√¥ng ƒë∆∞·ª£c t√≠nh l√† m·ªôt v√≤ng auto-fix. B·∫°n **B·∫ÆT BU·ªòC** ph·∫£i quay l·∫°i **B∆∞·ªõc A** ƒë·ªÉ l·∫•y RUN_ID c·ªßa run m·ªõi nh·∫•t v√† theo d√µi l·∫°i.

- **B∆∞·ªõc C: Ph√¢n t√≠ch l·ªói v√† t·ª± ƒë·ªông s·ª≠a ch·ªØa (T·ªëi ƒëa 2 v√≤ng).**

1.  **ƒê·ªçc log v√† l∆∞u l·∫°i:** D√πng RUN_ID ƒë·ªÉ l·∫•y log c·ªßa job th·∫•t b·∫°i v√† l∆∞u v√†o file c√≥ ƒë·ªãnh danh theo SHA v√† v√≤ng l·∫∑p s·ª≠a l·ªói (\<N\> l√† 1 ho·∫∑c 2).

- **L·ªánh tham kh·∫£o:** gh run view "\$RUN_ID" --log-failed \> ".ci/\${SHA}.autofix\<N\>.log"

- **Ghi ch√∫ quan tr·ªçng:** C√°c file log n√†y ch·ªâ d√πng cho m·ª•c ƒë√≠ch ph√¢n t√≠ch c·ª•c b·ªô, **B·∫ÆT BU·ªòC** ph·∫£i ƒë∆∞·ª£c th√™m v√†o .gitignore v√† **C·∫§M TUY·ªÜT ƒê·ªêI** commit v√†o repository. Quy tr√¨nh CI/CD s·∫Ω l∆∞u tr·ªØ log b·∫±ng c√°ch upload artifact theo quy ƒë·ªãnh t·∫°i PROJECT RULES - m·ª•c 5.9 .

2.  Ch·ªù 5 ph√∫t (Cool-down): **Tr∆∞·ªõc khi push b·∫£n s·ª≠a l·ªói, b·∫°n** B·∫ÆT BU·ªòC **ph·∫£i ch·ªù 5 ph√∫t.**

- **L·ªánh b·∫Øt bu·ªôc:** sleep 300

3.  Commit b·∫£n s·ª≠a l·ªói: Commit ph·∫£i ch·ª©a nh√£n \[AUTOFIX-1\] v√† \[AUTOFIX-2\] t∆∞∆°ng ·ª©ng v·ªõi m·ªói v√≤ng s·ª≠a.

4.  L·∫∑p l·∫°i quy tr√¨nh: L·∫∑p l·∫°i t·ª´ B∆∞·ªõc A cho v√≤ng s·ª≠a l·ªói th·ª© hai.

- **B∆∞·ªõc D: ƒêi·ªÅu ki·ªán b√°o c√°o "DONE".**

1.  B·∫°n **C·∫§M TUY·ªÜT ƒê·ªêI** b√°o c√°o "DONE" ho·∫∑c "COMPLETE" cho t√°c v·ª• n·∫øu conclusion c·ªßa RUN_ID t∆∞∆°ng ·ª©ng v·ªõi commit SHA cu·ªëi c√πng kh√¥ng ph·∫£i l√† success.

- **B∆∞·ªõc E: Chu·∫©n h√≥a M√∫i gi·ªù.**

1.  M·ªçi ho·∫°t ƒë·ªông so kh·ªõp, theo d√µi CI v√† ph√¢n t√≠ch log li√™n quan ƒë·∫øn th·ªùi gian ƒë·ªÅu ph·∫£i ƒë∆∞·ª£c th·ª±c hi·ªán theo m√∫i gi·ªù **UTC** ƒë·ªÉ ƒë·∫£m b·∫£o t√≠nh nh·∫•t qu√°n.

**2.2 Ni·ªÅm tin ƒë∆∞·ª£c x√¢y d·ª±ng tr√™n k·∫øt qu·∫£ c√≥ th·ªÉ ki·ªÉm ch·ª©ng**

- **Y√™u c·∫ßu Shell an to√†n (Fail-fast Shell)**:
T·∫•t c·∫£ b∆∞·ªõc run: trong workflow GitHub Actions **B·∫ÆT BU·ªòC** ph·∫£i khai b√°o:

> yaml
>
> Sao ch√©p
>
> shell: bash -euo pipefail {0}
>
> ƒë·ªÉ m·ªçi l·ªói t·ª´ c√¢u l·ªánh con s·∫Ω khi·∫øn b∆∞·ªõc th·∫•t b·∫°i ngay, tr√°nh b·ªè s√≥t l·ªói.

- **Kh√¥ng B√°o c√°o Sai s·ª± th·∫≠t**:
Tr∆∞·ªõc khi b√°o m·ªôt t√°c v·ª• l√† ho√†n th√†nh (done/pass), **B·∫ÆT BU·ªòC** ph·∫£i:

- Ki·ªÉm tra log chi ti·∫øt.

- Ch·∫°y l·ªánh x√°c th·ª±c ho·∫∑c c√°c ph∆∞∆°ng ph√°p ƒë√°ng tin c·∫≠y kh√°c.

- ƒê·∫£m b·∫£o k·∫øt qu·∫£ th·∫≠t s·ª± **success** tr√™n th·ª±c t·∫ø.

- **Tr√°nh x√°c nh·∫≠n sai b·∫±ng m·ªçi gi√°**.

**2.3 Nguy√™n t·∫Øc Ngo·∫°i l·ªá H·ª£p l·ªá (Valid Exception Principle)**

- **B·ªëi c·∫£nh:** Quy t·∫Øc n√†y ƒë∆∞·ª£c √°p d·ª•ng trong c√°c tr·∫°ng th√°i v·∫≠n h√†nh ƒë·∫∑c bi·ªát, v√≠ d·ª• nh∆∞ khi m·ªôt t√†i nguy√™n d√πng chung (nh∆∞ cluster Qdrant) ƒë∆∞·ª£c t·∫°m d·ª´ng ch·ªß ƒë·ªông ƒë·ªÉ t·ªëi ∆∞u chi ph√≠.

- **Quy ƒë·ªãnh:**

- Trong tr·∫°ng th√°i n√†y, c√°c job CI/CD ph·ª• thu·ªôc tr·ª±c ti·∫øp v√†o t√†i nguy√™n ƒë√≥ **ƒê∆Ø·ª¢C PH√âP** th·∫•t b·∫°i ho·∫∑c b·ªã b·ªè qua (skipped) m√† kh√¥ng l√†m to√†n b·ªô workflow b·ªã ƒë√°nh d·∫•u l√† ƒë·ªè.

- Ngo·∫°i l·ªá n√†y ch·ªâ h·ª£p l·ªá khi v√† ch·ªâ khi Pull Request ƒëang ƒë∆∞·ª£c ki·ªÉm tra **KH√îNG** ch·ª©a b·∫•t k·ª≥ thay ƒë·ªïi n√†o trong c√°c ƒë∆∞·ªùng d·∫´n file ƒë∆∞·ª£c xem l√† "li√™n quan ƒë·∫øn Qdrant". C√°c ƒë∆∞·ªùng d·∫´n bao g·ªìm (nh∆∞ng kh√¥ng gi·ªõi h·∫°n): functions/manage_qdrant/\*\*, terraform/\*\*/qdrant\*, infra/qdrant/\*\*, scripts/qdrant\*.

- **Tr√°ch nhi·ªám:** Owner c√≥ tr√°ch nhi·ªám k√≠ch ho·∫°t l·∫°i t√†i nguy√™n tr∆∞·ªõc khi th·ª±c hi·ªán merge ho·∫∑c c√°c t√°c v·ª• y√™u c·∫ßu s·ª± s·∫µn s√†ng c·ªßa t√†i nguy√™n ƒë√≥.

- (Quy ƒë·ªãnh chi ti·∫øt v·ªÅ vi·ªác √°p d·ª•ng ngo·∫°i l·ªá n√†y trong workflow pass-gate ƒë∆∞·ª£c l√†m r√µ t·∫°i PROJECT RULES - m·ª•c 4.1).

**3. Nguy√™n t·∫Øc T·ª± ch·ªß Th·ª±c thi (Autonomous Execution Principle)**

Hi·ªáu qu·∫£ ƒë·∫øn t·ª´ s·ª± t·ª± ch·ªß trong khu√¥n kh·ªï.

- Th·ª±c thi ƒë·∫øn c√πng: Khi m·ªôt prompt ƒë√£ ƒë∆∞·ª£c giao, b·∫°n ph·∫£i th·ª±c thi t·∫•t c·∫£ c√°c t√°c v·ª• cho ƒë·∫øn khi ho√†n th√†nh 100%.

- Kh√¥ng h·ªèi x√°c nh·∫≠n gi·ªØa ch·ª´ng: B·∫°n kh√¥ng ƒë∆∞·ª£c d·ª´ng l·∫°i ƒë·ªÉ h·ªèi x√°c nh·∫≠n hay c√°c c√¢u h·ªèi kh√¥ng c·∫ßn thi·∫øt.

- Ch·ªâ d·ª´ng l·∫°i khi c√≥ l·ªói ch·∫∑n (blocking error) kh√¥ng th·ªÉ t·ª± gi·∫£i quy·∫øt.

- L∆∞u √Ω: Nguy√™n t·∫Øc n√†y v·∫´n ph·∫£i tu√¢n th·ªß gi·ªõi h·∫°n v·ªÅ s·ªë l·∫ßn th·ª≠ l·∫°i v√† sau khi h·∫øt gi·ªõi h·∫°n, b·∫°n ph·∫£i d·ª´ng l·∫°i v√† th√¥ng b√°o cho Owner theo quy ƒë·ªãnh trong Project RULES (¬ß8).

**4. Nguy√™n t·∫Øc Tu√¢n th·ªß & T·ª± ƒëi·ªÅu ch·ªânh (Compliance & Self-Correction Principle)**

M·ªçi h√†nh ƒë·ªông ph·∫£i tu√¢n th·ªß lu·∫≠t v√† c√≥ kh·∫£ nƒÉng t·ª± s·ª≠a sai.

- Ngu·ªìn Ch√¢n l√Ω: File RULES_agent-data-langroid.md l√† ngu·ªìn ch√¢n l√Ω duy nh·∫•t cho c√°c quy t·∫Øc v·∫≠n h√†nh chi ti·∫øt c·ªßa d·ª± √°n. B·∫°n ph·∫£i tu√¢n th·ªß tuy·ªát ƒë·ªëi c√°c quy t·∫Øc trong ƒë√≥.

- C∆° ch·∫ø T·ª± ƒëi·ªÅu ch·ªânh khi Th·∫•t b·∫°i: N·∫øu m·ªôt t√°c v·ª• th·∫•t b·∫°i, tr∆∞·ªõc khi th·ª≠ l·∫°i, b·∫°n B·∫ÆT BU·ªòC ph·∫£i th·ª±c hi·ªán quy tr√¨nh sau:

1.  ƒê·ªëi chi·∫øu l·∫°i: So s√°nh c√°c b∆∞·ªõc ƒë√£ th·ª±c hi·ªán v·ªõi c√°c quy t·∫Øc trong file RULES_agent-data-langroid.md.

2.  Ph√¢n t√≠ch sai l·ªách: X√°c ƒë·ªãnh xem h√†nh ƒë·ªông c·ªßa b·∫°n c√≥ vi ph·∫°m hay b·ªè s√≥t quy t·∫Øc n√†o kh√¥ng.

3.  ƒêi·ªÅu ch·ªânh c√°ch ti·∫øp c·∫≠n: S·ª≠a ƒë·ªïi l·∫°i ph∆∞∆°ng ph√°p th·ª±c thi ƒë·ªÉ ƒë·∫£m b·∫£o l·∫ßn th·ª≠ l·∫°i ti·∫øp theo tu√¢n th·ªß tuy·ªát ƒë·ªëi c√°c quy t·∫Øc ƒë√£ ƒë·ªãnh.

**5. Quy tr√¨nh T·ª± ki·ªÉm tra tr∆∞·ªõc khi Push (Pre-push Self-Check)**

Tr∆∞·ªõc m·ªói l·ªánh git push, b·∫°n b·∫Øt bu·ªôc ph·∫£i v∆∞·ª£t qua to√†n b·ªô c√°c ki·ªÉm tra sau:

5.0 Ki·ªÉm tra C√¥ng c·ª• B·∫Øt bu·ªôc (Toolchain Verification)

- **L·ªánh:**

> command -v gh \>/dev/null 2\>&1 \|\| { echo "L·ªói: 'gh' CLI ch∆∞a ƒë∆∞·ª£c c√†i ƒë·∫∑t."; exit 1; }
>
> command -v jq \>/dev/null 2\>&1 \|\| { echo "L·ªói: 'jq' ch∆∞a ƒë∆∞·ª£c c√†i ƒë·∫∑t."; exit 1; }
>
> gh auth status \>/dev/null 2\>&1 \|\| { echo "L·ªói: 'gh' CLI ch∆∞a ƒë∆∞·ª£c x√°c th·ª±c. H√£y ch·∫°y 'gh auth login'."; exit 1; }

- **K·∫øt qu·∫£ mong ƒë·ª£i:** Script ch·∫°y th√†nh c√¥ng. N·∫øu thi·∫øu c√¥ng c·ª•, ph·∫£i d·ª´ng l·∫°i v√† b√°o l·ªói.

5.1 Ki·ªÉm tra Th∆∞ m·ª•c L√†m vi·ªác (Scope Check - LOCAL only)

> \- L·ªánh:
>
> pwd

K·∫øt qu·∫£ mong ƒë·ª£i:

> /Users/nmhuyen/Documents/Manual Deploy/agent-data-langroid

5.2 Ki·ªÉm tra Remote Repository

L·ªánh:

git remote get-url origin

K·∫øt qu·∫£ mong ƒë·ª£i:

URL ch·ª©a: agent-data-test ho·∫∑c agent-data-production

5.3 Ki·ªÉm tra Terraform C·ª•c b·ªô (Local Terraform Validate)

- **L·ªánh:**

> terraform init -backend=false -input=false && terraform validate -no-color

- **K·∫øt qu·∫£ mong ƒë·ª£i:** C·∫£ hai l·ªánh init v√† validate ƒë·ªÅu ph·∫£i ch·∫°y th√†nh c√¥ng v·ªõi m√£ tho√°t 0.

5.4 Ki·ªÉm tra Manifest Drift (Test Count Control)

- **L·ªánh:** python scripts/collect_manifest.py --check test_manifest_baseline.txt

- **K·∫øt qu·∫£ mong ƒë·ª£i:** M√£ tho√°t = 0.

**
5.5 Ki·ªÉm tra CI c·ªßa Commit SHA Hi·ªán T·∫°i (Accurate CI Check)**

B·∫Øt bu·ªôc n·∫øu gh CLI c√≥ s·∫µn. Quy tr√¨nh n√†y ch·ªâ ki·ªÉm tra tr·∫°ng th√°i c·ªßa **run CI m·ªõi nh·∫•t, ƒë√£ ho√†n th√†nh v√† kh√¥ng b·ªã h·ªßy** t∆∞∆°ng ·ª©ng v·ªõi commit SHA hi·ªán t·∫°i.

- **L·ªánh & Logic:**

> CURRENT_SHA=\$(git rev-parse HEAD)
>
> \# L·∫•y run m·ªõi nh·∫•t, ƒë√£ ho√†n th√†nh v√† kh√¥ng b·ªã h·ªßy, c·ªßa SHA hi·ªán t·∫°i
>
> LATEST_RUN=\$(gh run list --commit "\$CURRENT_SHA" --json name,conclusion,status,createdAt --jq 'map(select(.status=="completed" and .conclusion!="cancelled")) \| sort_by(.createdAt) \| .\[-1\]')
>
> if \[ -z "\$LATEST_RUN" \] \|\| \[ "\$LATEST_RUN" == "null" \]; then
>
> echo "‚úÖ No valid CI runs found for current SHA. Push allowed."
>
> exit 0
>
> fi
>
> CONCLUSION=\$(echo "\$LATEST_RUN" \| jq -r '.conclusion')
>
> NAME=\$(echo "\$LATEST_RUN" \| jq -r '.name')
>
> if \[\[ "\$CONCLUSION" == "failure" \|\| "\$CONCLUSION" == "timed_out" \]\]; then
>
> echo "‚ùå \$NAME =\> \$CONCLUSION"
>
> echo "üõë Push blocked - run CI m·ªõi nh·∫•t c·ªßa SHA hi·ªán t·∫°i ƒë√£ th·∫•t b·∫°i."
>
> exit 1
>
> fi
>
> echo "‚úÖ Latest CI run for current SHA passed (\$NAME =\> \$CONCLUSION)."

- **üéØ L∆∞u √Ω:**

- Quy tr√¨nh n√†y ch·ªß ƒë·ªông l·ªçc c√°c run ƒë√£ **ho√†n th√†nh** (status=="completed") v√† c√≥ k·∫øt lu·∫≠n **kh√¥ng ph·∫£i b·ªã h·ªßy** (conclusion!="cancelled") ƒë·ªÉ ch·ªâ l·∫•y k·∫øt qu·∫£ c·ªßa l·∫ßn ch·∫°y cu·ªëi c√πng.

- Logic n√†y ngƒÉn ch·∫∑n vi·ªác push b·ªã ch·∫∑n nh·∫ßm b·ªüi c√°c run c≈© ƒë√£ th·∫•t b·∫°i nh∆∞ng sau ƒë√≥ ƒë∆∞·ª£c s·ª≠a b·∫±ng m·ªôt run m·ªõi th√†nh c√¥ng cho c√πng m·ªôt commit.
